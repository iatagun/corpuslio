{% extends "corpus/base.html" %}
{% load i18n %}
{% load static %}

{% block title %}{% trans "Korpus Arama" %} - OCRchestra{% endblock %}

{% block extra_css %}
<style>
    .corpus-search-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 2rem;
    }
    
    .search-form-card {
        background: var(--bg-surface);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border-subtle);
        padding: 2rem;
        margin-bottom: 2rem;
    }
    
    .search-options {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .form-group {
        display: flex;
        flex-direction: column;
    }
    
    .form-group label {
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: var(--text-main);
        font-size: 0.875rem;
    }
    
    .form-group input,
    .form-group select {
        padding: 0.75rem;
        border: 1px solid var(--border-subtle);
        border-radius: var(--radius-md);
        font-size: 0.875rem;
        background: var(--bg-base);
        color: var(--text-main);
    }
    
    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: var(--accent-primary);
    }
    
    .form-group input[type="checkbox"] {
        width: auto;
        margin-right: 0.5rem;
    }
    
    .checkbox-wrapper {
        display: flex;
        align-items: center;
    }
    
    .search-button {
        background: var(--accent-primary);
        color: white;
        padding: 0.875rem 2rem;
        border: none;
        border-radius: var(--radius-md);
        font-size: 0.9375rem;
        font-weight: 600;
        cursor: pointer;
        width: 100%;
        margin-top: 1rem;
        transition: all 0.2s ease;
    }
    
    .search-button:hover {
        background: var(--accent-hover);
        transform: translateY(-1px);
    }
    
    .results-card {
        background: var(--bg-surface);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border-subtle);
        padding: 2rem;
    }
    
    .results-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--border-subtle);
    }
    
    .export-buttons {
        display: flex;
        gap: 0.75rem;
    }
    
    .btn-export {
        display: flex;
        align-items: center;
        gap: 0.375rem;
        padding: 0.5rem 1rem;
        border-radius: var(--radius-md);
        font-size: 0.875rem;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.2s ease;
        border: 1px solid var(--border-subtle);
        background: var(--bg-base);
        color: var(--text-main);
    }
    
    .btn-export:hover {
        background: var(--bg-surface-hover);
        border-color: var(--accent-primary);
        color: var(--accent-primary);
        transform: translateY(-1px);
    }
    
    .btn-export .material-icons {
        font-size: 18px;
    }
    
    .results-stats {
        font-size: 0.875rem;
        color: var(--text-secondary);
    }
    
    .execution-time {
        font-weight: 600;
        color: var(--accent-success);
    }
    
    .concordance-line {
        padding: 1rem;
        margin-bottom: 0.75rem;
        border-left: 3px solid var(--accent-primary);
        background: var(--bg-base);
        border-radius: var(--radius-sm);
        font-family: 'Courier New', monospace;
        font-size: 0.875rem;
        line-height: 1.6;
    }
    
    .concordance-line:hover {
        background: var(--bg-surface-hover);
        border-left-color: var(--accent-hover);
    }
    
    .context-left {
        color: var(--text-secondary);
        text-align: right;
        display: inline-block;
        min-width: 45%;
    }
    
    .keyword {
        color: var(--accent-primary);
        font-weight: bold;
        padding: 0 0.5rem;
        background: var(--bg-surface);
        border-radius: var(--radius-sm);
    }
    
    .context-right {
        color: var(--text-secondary);
        display: inline-block;
        min-width: 45%;
    }
    
    .concordance-meta {
        margin-top: 0.5rem;
        font-size: 0.75rem;
        color: var(--text-tertiary);
        font-family: 'Inter', sans-serif;
    }
    
    .concordance-meta .doc-title {
        font-weight: 600;
        color: var(--accent-primary);
    }
    
    .concordance-meta .lemma,
    .concordance-meta .pos {
        background: var(--bg-surface-hover);
        padding: 2px 6px;
        border-radius: var(--radius-sm);
        margin-left: 0.5rem;
    }
    
    .no-results {
        text-align: center;
        padding: 3rem;
        color: var(--text-secondary);
    }
    
    .no-results-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        color: var(--text-tertiary);
    }
    
    .rate-limit-warning {
        background: var(--bg-surface);
        border-left: 4px solid var(--accent-danger);
        padding: 1rem;
        margin-bottom: 1rem;
        border-radius: var(--radius-md);
        color: var(--text-main);
    }
</style>
{% endblock %}

{% block content %}
<div class="corpus-search-container">
    <h1>üîç {% trans "Korpus Arama (KWIC)" %}</h1>
    <p style="color: var(--text-secondary); margin-bottom: 2rem;">
        {% trans "Dilbilimsel a√ßƒ±klamalƒ± korpus dosylarƒ±nda anahtar kelime baƒülamda (Key Word In Context) arama yapƒ±n." %}
    </p>
    
    {% if request.limited %}
    <div class="rate-limit-warning">
        <strong>‚ö†Ô∏è {% trans "Hƒ±z Limiti A≈üƒ±ldƒ±" %}</strong><br>
        {% trans "Saatte en fazla 100 arama yapabilirsiniz. L√ºtfen biraz bekleyin." %}
    </div>
    {% endif %}
    
    <div class="search-form-card">
        <form method="get" action="{% url 'corpus:corpus_search' %}">
            <div class="form-group">
                <label for="query">{% trans "Arama Sorgusu" %} <span style="color: red;">*</span></label>
                <input type="text" 
                       id="query" 
                       name="q" 
                       value="{{ query }}" 
                       placeholder="{% trans '√ñrnek: git.* (regex) veya kitap (tam e≈üle≈üme)' %}"
                       required>
            </div>
            
            <div class="search-options">
                <div class="form-group">
                    <label for="type">{% trans "Arama Tipi" %}</label>
                    <select id="type" name="type">
                        <option value="form" {% if search_type == 'form' %}selected{% endif %}>{% trans "Y√ºzey Formu (Form)" %}</option>
                        <option value="lemma" {% if search_type == 'lemma' %}selected{% endif %}>{% trans "K√∂k (Lemma)" %}</option>
                        <option value="upos" {% if search_type == 'upos' %}selected{% endif %}>{% trans "POS Etiketi" %}</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="context">{% trans "Baƒülam Boyutu (token)" %}</label>
                    <input type="number" 
                           id="context" 
                           name="context" 
                           value="{{ context|default:5 }}" 
                           min="1" 
                           max="50">
                </div>
                
                <div class="form-group">
                    <label for="limit">{% trans "Maksimum Sonu√ß" %}</label>
                    <input type="number" 
                           id="limit" 
                           name="limit" 
                           value="{{ limit|default:100 }}" 
                           min="10" 
                           max="1000">
                </div>
                
                <div class="form-group">
                    <label for="collection">{% trans "Koleksiyon Filtresi" %}</label>
                    <select id="collection" name="collection">
                        <option value="">{% trans "T√ºm Dok√ºmanlar" %}</option>
                        {% for coll in collections %}
                        <option value="{{ coll.id }}" {% if selected_collection == coll.id|stringformat:"s" %}selected{% endif %}>{{ coll.name }} ({{ coll.document_count }})</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="genre">{% trans "T√ºr Filtresi" %}</label>
                    <select id="genre" name="genre">
                        <option value="">{% trans "T√ºm T√ºrler" %}</option>
                        {% for g in genres %}
                        <option value="{{ g }}" {% if selected_genre == g %}selected{% endif %}>{{ g }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="author">{% trans "Yazar Filtresi" %}</label>
                    <select id="author" name="author">
                        <option value="">{% trans "T√ºm Yazarlar" %}</option>
                        {% for a in authors %}
                        <option value="{{ a }}" {% if selected_author == a %}selected{% endif %}>{{ a }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="sort">{% trans "Sƒ±ralama" %}</label>
                    <select id="sort" name="sort">
                        <option value="none" {% if sort_by == 'none' %}selected{% endif %}>{% trans "Varsayƒ±lan" %}</option>
                        <option value="left" {% if sort_by == 'left' %}selected{% endif %}>{% trans "Sol Baƒülama G√∂re" %}</option>
                        <option value="right" {% if sort_by == 'right' %}selected{% endif %}>{% trans "Saƒü Baƒülama G√∂re" %}</option>
                        <option value="document" {% if sort_by == 'document' %}selected{% endif %}>{% trans "Belgeye G√∂re" %}</option>
                    </select>
                </div>
            </div>
            
            <div class="search-options" style="grid-template-columns: 1fr 1fr;">
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="regex" name="regex" {% if regex %}checked{% endif %}>
                    <label for="regex" style="margin: 0;">{% trans "Regex Kullan (.*+?^$)" %}</label>
                </div>
                
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="case" name="case" {% if case_sensitive %}checked{% endif %}>
                    <label for="case" style="margin: 0;">{% trans "B√ºy√ºk/K√º√ß√ºk Harf Duyarlƒ±" %}</label>
                </div>
            </div>
            
            <button type="submit" class="search-button">
                üîç {% trans "Ara" %}
            </button>
        </form>
    </div>
    
    {% if results %}
    <div class="results-card">
        <div class="results-header">
            <div>
                <h2>{% trans "Arama Sonu√ßlarƒ±" %}</h2>
                <div class="results-stats">
                    üìä <strong>{{ total_matches }}</strong> {% trans "sonu√ß" %}
                    {% if unique_docs %}
                    &nbsp;|&nbsp; üìÑ <strong>{{ unique_docs }}</strong> {% trans "belge" %}
                    {% endif %}
                    {% if execution_time %}
                    &nbsp;|&nbsp; ‚ö° <span class="execution-time">{{ execution_time|floatformat:0 }}ms</span>
                    {% endif %}
                </div>
            </div>
            {% if user.is_authenticated %}
            <div class="export-buttons">
                <a href="{% url 'corpus:export_concordance' %}?{{ request.GET.urlencode }}&format=csv" 
                   class="btn-export btn-csv" 
                   title="CSV formatƒ±nda indir (su damgalƒ±)">
                    <span class="material-icons">download</span> CSV
                </a>
                <a href="{% url 'corpus:export_concordance' %}?{{ request.GET.urlencode }}&format=json" 
                   class="btn-export btn-json" 
                   title="JSON formatƒ±nda indir (metadata ile)">
                    <span class="material-icons">code</span> JSON
                </a>
            </div>
            {% endif %}
        </div>
        
        {% if user.is_authenticated and user.profile.role == 'verified' %}
        <div style="background:linear-gradient(90deg,rgba(16,185,129,0.06),rgba(6,182,212,0.06)); border:1px solid rgba(16,185,129,0.15); border-radius:8px; padding:0.65rem 0.85rem; margin-bottom:1rem; display:flex; align-items:center; gap:0.45rem; font-size:0.8rem;">
            <span class="material-icons" style="color:#10b981; font-size:17px;">verified</span>
            <span style="color:var(--text-secondary);">Export'larƒ±nƒ±z <strong style="color:#10b981;">tam dilbilimsel a√ßƒ±klamalar</strong> i√ßerir (UPOS, XPOS, morfoloji, dependency)</span>
        </div>
        {% endif %}
        
        {% for result in results %}
        <div class="concordance-line">
            <span class="context-left">{{ result.left }}</span>
            <span class="keyword">{{ result.keyword }}</span>
            <span class="context-right">{{ result.right }}</span>
            
            <div class="concordance-meta">
                <span class="doc-title">üìÑ {{ result.document.title }}</span>
                <span class="lemma">Lemma: {{ result.lemma }}</span>
                <span class="pos">POS: {{ result.pos }}</span>
                <span style="color: var(--text-tertiary);">| C√ºmle #{{ result.sentence_id }}</span>
            </div>
        </div>
        {% endfor %}
    </div>
    {% elif query %}
    <div class="no-results">
        <div class="no-results-icon">üîç</div>
        <h3>{% trans "Sonu√ß Bulunamadƒ±" %}</h3>
        <p>{% trans "Farklƒ± arama parametreleri deneyin veya regex kullanarak arama yapƒ±n." %}</p>
    </div>
    {% endif %}
</div>
{% endblock %}
