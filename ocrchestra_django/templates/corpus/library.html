{% extends "corpus/base.html" %}

{% block title %}Kütüphane - OCRchestra{% endblock %}

{% block content %}
<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
    <h2><span class="material-icons" style="vertical-align:middle; margin-right:0.5rem;">library_books</span> Mevcut
        Kitaplar</h2>
    <span class="badge" style="background:var(--bg-surface); color:var(--text-secondary);">{{ page_obj.paginator.count
        }}
        kaynak</span>
</div>

<!-- Search and Filters -->
<div class="card filter-section">
    <form method="GET" class="filter-form">
        <div class="filter-grid">
            <input type="text" name="q" value="{{ request.GET.q }}" placeholder="Dosya adı, yazar..."
                class="form-control">

            <input type="text" name="author" value="{{ request.GET.author }}" placeholder="Yazar" class="form-control">

            <select name="genre" class="form-control" id="genreSelect">
                <option value="">-- Tür --</option>
                {% for genre in all_genres %}
                <option value="{{ genre }}">{{ genre|title }}</option>
                {% endfor %}
            </select>
            <script>
                // Set selected genre from URL parameter (Robust Solution)
                document.addEventListener('DOMContentLoaded', function () {
                    const urlParams = new URLSearchParams(window.location.search);
                    const genre = urlParams.get('genre');
                    if (genre) {
                        const select = document.getElementById('genreSelect');
                        // Find option with specific value
                        for (let i = 0; i < select.options.length; i++) {
                            if (select.options[i].value === genre) {
                                select.selectedIndex = i;
                                break;
                            }
                        }
                    }
                });
            </script>

            <input type="text" name="date" value="{{ request.GET.date }}" placeholder="Tarih" class="form-control">

            <button type="submit" class="btn btn-primary">Filtrele</button>
            <a href="{% url 'corpus:library' %}" class="btn btn-outline" style="text-align:center;">Temizle</a>
        </div>
    </form>
</div>

{% if documents %}
<div class="documents-grid">
    {% for doc in documents %}
    <div class="card document-card">
        <h3>{{ doc.filename }}</h3>
        <p class="meta">
            <span class="format-badge">{{ doc.format }}</span>
            <span class="date" style="display:flex; align-items:center; gap:0.25rem;">
                <span class="material-icons" style="font-size:14px;">calendar_today</span>
                {{ doc.upload_date|date:"d.m.Y" }}
            </span>
        </p>

        <p class="status">
            {% if doc.processed %}
            <span
                style="display:flex; align-items:center; gap:0.25rem; color:var(--accent-success); font-weight:500; font-size:0.85rem;">
                <span class="material-icons" style="font-size:16px;">check_circle</span> İşlendi
            </span>
            <span class="word-count">{{ doc.get_word_count }} kelime</span>
            {% else %}
            <span
                style="display:flex; align-items:center; gap:0.25rem; color:var(--text-secondary); font-size:0.85rem;">
                <span class="material-icons" style="font-size:16px;">hourglass_empty</span> Bekliyor
            </span>
            {% endif %}
        </p>

        <div class="actions">
            {% if doc.processed %}
            <a href="{% url 'corpus:analysis' doc.id %}" class="btn btn-secondary btn-small">İncele</a>
            <a href="{% url 'corpus:export' doc.id %}?format=vrt" class="btn btn-outline btn-small">VRT</a>
            {% endif %}
            <form method="POST" action="{% url 'corpus:delete' doc.id %}" style="display:inline;"
                onsubmit="return confirm('Silmek istediğinize emin misiniz?');">
                {% csrf_token %}
                <button type="submit" class="btn btn-small btn-danger" style="border:none;">
                    <span class="material-icons" style="font-size:16px;">delete</span>
                </button>
            </form>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Pagination Controls -->
{% if page_obj.has_other_pages %}
<div class="pagination-container" style="display:flex; justify-content:center; margin-top:3rem;">
    <div class="pagination" style="display:flex; gap:0.5rem; align-items:center;">
        {% if page_obj.has_previous %}
        <a href="?page=1{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.author %}&author={{ request.GET.author }}{% endif %}{% if request.GET.genre %}&genre={{ request.GET.genre }}{% endif %}{% if request.GET.date %}&date={{ request.GET.date }}{% endif %}"
            class="btn btn-outline btn-small">&laquo; İlk</a>
        <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.author %}&author={{ request.GET.author }}{% endif %}{% if request.GET.genre %}&genre={{ request.GET.genre }}{% endif %}{% if request.GET.date %}&date={{ request.GET.date }}{% endif %}"
            class="btn btn-outline btn-small">&lsaquo; Önceki</a>
        {% endif %}

        <span class="current" style="color:var(--text-secondary); font-size:0.9rem; margin:0 1rem;">
            Sayfa {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}
        </span>

        {% if page_obj.has_next %}
        <a href="?page={{ page_obj.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.author %}&author={{ request.GET.author }}{% endif %}{% if request.GET.genre %}&genre={{ request.GET.genre }}{% endif %}{% if request.GET.date %}&date={{ request.GET.date }}{% endif %}"
            class="btn btn-outline btn-small">Sonraki &rsaquo;</a>
        <a href="?page={{ page_obj.paginator.num_pages }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}{% if request.GET.author %}&author={{ request.GET.author }}{% endif %}{% if request.GET.genre %}&genre={{ request.GET.genre }}{% endif %}{% if request.GET.date %}&date={{ request.GET.date }}{% endif %}"
            class="btn btn-outline btn-small">Son &raquo;</a>
        {% endif %}
    </div>
</div>
{% endif %}

{% else %}
<div class="alert alert-info" style="display:flex; align-items:center; gap:0.5rem;">
    <span class="material-icons">info</span>
    <p>Kütüphane boş. 'Yeni Ekle' sekmesinden kitap ekleyebilirsiniz.</p>
</div>
{% endif %}

<style>
    .documents-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 1.5rem;
    }

    .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        align-items: center;
    }
</style>
<script>
    // Auto-submit form when select changes (optional)
    document.querySelector('select[name="genre"]').addEventListener('change', function () {
        this.form.submit();
    });
</script>
{% endblock %}