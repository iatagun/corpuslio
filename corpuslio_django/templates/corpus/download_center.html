{% extends 'base.html' %}
{% load static %}

{% block title %}Download Center - OCRchestra{% endblock %}

{% block extra_css %}
<style>
    .download-center-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .header-section {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 30px;
        border-radius: 10px;
        margin-bottom: 30px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .header-section h1 {
        margin: 0 0 10px 0;
        font-size: 2em;
    }
    
    .stats-row {
        display: flex;
        gap: 30px;
        margin-top: 15px;
    }
    
    .stat-item {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .stat-item .material-icons {
        font-size: 1.5em;
    }
    
    .filters-section {
        background: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .filters-form {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        align-items: end;
    }
    
    .filter-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #666;
    }
    
    .filter-group input,
    .filter-group select {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 0.9em;
    }
    
    .filter-group button {
        padding: 10px 20px;
        background: #10b981;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-weight: 500;
        transition: background 0.2s;
    }
    
    .filter-group button:hover {
        background: #059669;
    }
    
    .exports-table-container {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .exports-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .exports-table thead {
        background: #f8f9fa;
    }
    
    .exports-table th {
        padding: 15px;
        text-align: left;
        font-weight: 600;
        color: #333;
        border-bottom: 2px solid #e5e7eb;
    }
    
    .exports-table td {
        padding: 15px;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .exports-table tbody tr:hover {
        background: #f9fafb;
    }
    
    .format-badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 0.8em;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .format-csv { background: #dbeafe; color: #1e40af; }
    .format-json { background: #fef3c7; color: #92400e; }
    .format-excel { background: #d1fae5; color: #065f46; }
    .format-conllu { background: #e9d5ff; color: #6b21a8; }
    
    .download-btn {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 8px 16px;
        background: #10b981;
        color: white;
        text-decoration: none;
        border-radius: 5px;
        font-size: 0.9em;
        transition: background 0.2s;
    }
    
    .download-btn:hover {
        background: #059669;
    }
    
    .pagination {
        display: flex;
        justify-content: center;
        padding: 30px 20px;
        gap: 10px;
    }
    
    .pagination a,
    .pagination span {
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 5px;
        text-decoration: none;
        color: #333;
        transition: all 0.2s;
    }
    
    .pagination a:hover {
        background: #10b981;
        color: white;
        border-color: #10b981;
    }
    
    .pagination .current {
        background: #10b981;
        color: white;
        border-color: #10b981;
    }
    
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #999;
    }
    
    .empty-state .material-icons {
        font-size: 4em;
        opacity: 0.3;
        margin-bottom: 15px;
    }
    
    .watermark-icon {
        color: #10b981;
        font-size: 1.2em;
        vertical-align: middle;
    }
    
    @media (max-width: 768px) {
        .exports-table {
            font-size: 0.85em;
        }
        
        .exports-table th,
        .exports-table td {
            padding: 10px;
        }
        
        .filters-form {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="download-center-container">
    <!-- Header -->
    <div class="header-section">
        <h1><span class="material-icons" style="vertical-align: middle; font-size: 1.2em;">folder_open</span> Download Center</h1>
        <p>Browse and download your exported files</p>
        
        <div class="stats-row">
            <div class="stat-item">
                <span class="material-icons">description</span>
                <div>
                    <strong>{{ total_exports }}</strong> Total Exports
                </div>
            </div>
            <div class="stat-item">
                <span class="material-icons">storage</span>
                <div>
                    <strong>{{ total_size_mb }} MB</strong> Total Size
                </div>
            </div>
        </div>
    </div>
    
    <!-- Filters -->
    <div class="filters-section">
        <form method="get" class="filters-form">
            <div class="filter-group">
                <label for="format">Format</label>
                <select name="format" id="format">
                    <option value="">All Formats</option>
                    {% for fmt in available_formats %}
                    <option value="{{ fmt }}" {% if current_format == fmt %}selected{% endif %}>
                        {{ fmt|upper }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="filter-group">
                <label for="date_from">From Date</label>
                <input type="date" name="date_from" id="date_from" value="{{ date_from }}">
            </div>
            
            <div class="filter-group">
                <label for="date_to">To Date</label>
                <input type="date" name="date_to" id="date_to" value="{{ date_to }}">
            </div>
            
            <div class="filter-group">
                <button type="submit">
                    <span class="material-icons" style="vertical-align: middle; font-size: 1em;">filter_list</span>
                    Apply Filters
                </button>
            </div>
        </form>
    </div>
    
    <!-- Exports Table -->
    <div class="exports-table-container">
        {% if export_logs %}
        <table class="exports-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Document</th>
                    <th>Format</th>
                    <th>Size</th>
                    <th>Type</th>
                    <th>Watermark</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                {% for log in export_logs %}
                <tr>
                    <td>{{ log.timestamp|date:"Y-m-d H:i" }}</td>
                    <td>
                        <strong>{{ log.document.title|default:log.document.filename|truncatewords:8 }}</strong>
                    </td>
                    <td>
                        <span class="format-badge format-{{ log.export_format }}">
                            {{ log.export_format }}
                        </span>
                    </td>
                    <td>
                        {% if log.file_size_mb %}
                            {{ log.file_size_mb|floatformat:2 }} MB
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>{{ log.export_type|title }}</td>
                    <td>
                        {% if log.watermarked %}
                            <span class="material-icons watermark-icon" title="Watermarked">verified</span>
                        {% else %}
                            <span style="color: #ccc;">-</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if log.export_format == 'csv' %}
                            <a href="{% url 'corpus:export_csv_data' log.document.id %}" class="download-btn">
                                <span class="material-icons" style="font-size: 1em;">download</span>
                                Download
                            </a>
                        {% elif log.export_format == 'json' %}
                            <a href="{% url 'corpus:export_document' log.document.id %}?format=json" class="download-btn">
                                <span class="material-icons" style="font-size: 1em;">download</span>
                                Download
                            </a>
                        {% elif log.export_format == 'excel' %}
                            <a href="{% url 'corpus:export_excel_statistics' log.document.id %}" class="download-btn">
                                <span class="material-icons" style="font-size: 1em;">download</span>
                                Download
                            </a>
                        {% elif log.export_format == 'conllu' %}
                            <a href="{% url 'corpus:export_conllu_watermarked' log.document.id %}" class="download-btn">
                                <span class="material-icons" style="font-size: 1em;">download</span>
                                Download
                            </a>
                        {% else %}
                            <span style="color: #999;">Not available</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        <!-- Pagination -->
        {% if page_obj.has_other_pages %}
        <div class="pagination">
            {% if page_obj.has_previous %}
                <a href="?page=1{% if current_format %}&format={{ current_format }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">
                    First
                </a>
                <a href="?page={{ page_obj.previous_page_number }}{% if current_format %}&format={{ current_format }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">
                    Previous
                </a>
            {% endif %}
            
            <span class="current">
                Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
            </span>
            
            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}{% if current_format %}&format={{ current_format }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">
                    Next
                </a>
                <a href="?page={{ page_obj.paginator.num_pages }}{% if current_format %}&format={{ current_format }}{% endif %}{% if date_from %}&date_from={{ date_from }}{% endif %}{% if date_to %}&date_to={{ date_to }}{% endif %}">
                    Last
                </a>
            {% endif %}
        </div>
        {% endif %}
        
        {% else %}
        <div class="empty-state">
            <span class="material-icons">inbox</span>
            <h3>No exports found</h3>
            <p>You haven't exported any files yet, or no files match your filters.</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
