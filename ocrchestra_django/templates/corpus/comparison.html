{% extends "corpus/base.html" %}
{% load static %}

{% block title %}Korpus Karşılaştırma - CorpusIO{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h1 style="display:flex; align-items:center; gap:0.75rem;">
            <span class="material-icons" style="font-size:32px;">compare_arrows</span>
            Korpus Karşılaştırma
        </h1>
        <p class="subtitle">İki belgeyi yan yana karşılaştırın ve benzerlik/farklılık analizini görüntüleyin</p>
    </div>
</div>

<!-- Document Selection -->
<div class="card" style="margin-bottom:2rem;">
    <h2 style="margin-bottom:1.5rem;">Belge Seçimi</h2>
    <form method="GET" action="{% url 'corpus:comparison' %}" class="comparison-form">
        <div class="comparison-selects">
            <div class="select-group">
                <label for="doc1Select">
                    <span class="material-icons">description</span>
                    Belge 1
                </label>
                <select name="doc1" id="doc1Select" class="form-control" required>
                    <option value="">Belge seçin...</option>
                    {% for doc in documents %}
                    <option value="{{ doc.id }}" {% if doc1 and doc.id == doc1.id %}selected{% endif %}>
                        {{ doc.title|truncatechars:60 }} ({{ doc.get_word_count }} kelime)
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="comparison-icon">
                <span class="material-icons">compare_arrows</span>
            </div>
            
            <div class="select-group">
                <label for="doc2Select">
                    <span class="material-icons">description</span>
                    Belge 2
                </label>
                <select name="doc2" id="doc2Select" class="form-control" required>
                    <option value="">Belge seçin...</option>
                    {% for doc in documents %}
                    <option value="{{ doc.id }}" {% if doc2 and doc.id == doc2.id %}selected{% endif %}>
                        {{ doc.title|truncatechars:60 }} ({{ doc.get_word_count }} kelime)
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>
        
        <button type="submit" class="btn btn-primary" style="margin-top:1.5rem;">
            <span class="material-icons">analytics</span>
            Karşılaştır
        </button>
    </form>
</div>

{% if comparison_data %}
<!-- Results Section -->
<div class="comparison-results">
    <!-- Document Headers -->
    <div class="comparison-headers">
        <div class="doc-header">
            <h3>{{ doc1.title }}</h3>
            <p class="meta">
                <span class="format-badge">{{ doc1.format }}</span>
                <span>{{ doc1.upload_date|date:"d.m.Y" }}</span>
            </p>
        </div>
        <div class="doc-header">
            <h3>{{ doc2.title }}</h3>
            <p class="meta">
                <span class="format-badge">{{ doc2.format }}</span>
                <span>{{ doc2.upload_date|date:"d.m.Y" }}</span>
            </p>
        </div>
    </div>
    
    <!-- Statistics Cards -->
    <div class="stats-grid" style="margin-bottom:2rem;">
        <div class="stat-card stat-blue">
            <div class="stat-icon"><span class="material-icons">functions</span></div>
            <div class="stat-content">
                <div class="stat-label">Ortak Kelimeler</div>
                <div class="stat-value" id="commonWordsCount">-</div>
            </div>
        </div>
        
        <div class="stat-card stat-green">
            <div class="stat-icon"><span class="material-icons">grain</span></div>
            <div class="stat-content">
                <div class="stat-label">Ortak Kökler</div>
                <div class="stat-value" id="commonLemmasCount">-</div>
            </div>
        </div>
        
        <div class="stat-card stat-purple">
            <div class="stat-icon"><span class="material-icons">percent</span></div>
            <div class="stat-content">
                <div class="stat-label">Kelime Benzerliği</div>
                <div class="stat-value" id="wordSimilarity">-</div>
            </div>
        </div>
        
        <div class="stat-card stat-orange">
            <div class="stat-icon"><span class="material-icons">timeline</span></div>
            <div class="stat-content">
                <div class="stat-label">Kök Benzerliği</div>
                <div class="stat-value" id="lemmaSimilarity">-</div>
            </div>
        </div>
    </div>
    
    <!-- Basic Stats Comparison -->
    <div class="card" style="margin-bottom:2rem;">
        <h2 style="margin-bottom:1.5rem;">Temel İstatistikler</h2>
        <canvas id="basicStatsChart" style="max-height:300px;"></canvas>
    </div>
    
    <!-- Common Words -->
    <div class="card" style="margin-bottom:2rem;">
        <h2 style="margin-bottom:1rem;">
            <span class="material-icons" style="vertical-align:middle;">compare</span>
            Ortak Kelimeler (Frekans Toplamına Göre)
        </h2>
        <canvas id="commonWordsChart" style="max-height:400px;"></canvas>
    </div>
    
    <!-- Unique Words Comparison -->
    <div class="comparison-grid">
        <div class="card">
            <h3 style="margin-bottom:1rem; color:var(--accent-primary);">
                <span class="material-icons" style="vertical-align:middle;">star</span>
                {{ doc1.title|truncatechars:40 }} - Benzersiz
            </h3>
            <canvas id="uniqueWords1Chart" style="max-height:350px;"></canvas>
        </div>
        
        <div class="card">
            <h3 style="margin-bottom:1rem; color:var(--accent-success);">
                <span class="material-icons" style="vertical-align:middle;">star</span>
                {{ doc2.title|truncatechars:40 }} - Benzersiz
            </h3>
            <canvas id="uniqueWords2Chart" style="max-height:350px;"></canvas>
        </div>
    </div>
    
    <!-- POS Distribution -->
    <div class="card" style="margin-top:2rem;">
        <h2 style="margin-bottom:1.5rem;">POS Etiket Dağılımı Karşılaştırması</h2>
        <canvas id="posComparisonChart" style="max-height:350px;"></canvas>
    </div>
</div>
{% else %}
<div class="empty-state">
    <span class="material-icons">compare_arrows</span>
    <p>Karşılaştırma yapmak için iki belge seçin</p>
</div>
{% endif %}

<style>
    .comparison-form {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    
    .comparison-selects {
        display: grid;
        grid-template-columns: 1fr auto 1fr;
        gap: 2rem;
        align-items: end;
    }
    
    .select-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .select-group label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 500;
        color: var(--text-secondary);
    }
    
    .comparison-icon {
        display: flex;
        align-items: center;
        justify-content: center;
        padding-bottom: 0.5rem;
    }
    
    .comparison-icon .material-icons {
        font-size: 48px;
        color: var(--text-tertiary);
    }
    
    .comparison-headers {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
    }
    
    .doc-header {
        padding: 1.5rem;
        background: var(--bg-surface);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border-subtle);
    }
    
    .doc-header h3 {
        margin-bottom: 0.5rem;
        color: var(--accent-primary);
    }
    
    .comparison-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
    }
    
    .stat-card {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1.5rem;
        background: var(--bg-surface);
        border-radius: var(--radius-lg);
        border: 1px solid var(--border-subtle);
    }
    
    .stat-icon {
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: var(--radius-md);
        background: rgba(59, 130, 246, 0.1);
    }
    
    .stat-blue .stat-icon { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }
    .stat-green .stat-icon { background: rgba(16, 185, 129, 0.15); color: #10b981; }
    .stat-purple .stat-icon { background: rgba(168, 85, 247, 0.15); color: #a855f7; }
    .stat-orange .stat-icon { background: rgba(251, 146, 60, 0.15); color: #fb923c; }
    
    .stat-content {
        flex: 1;
    }
    
    .stat-label {
        font-size: 0.875rem;
        color: var(--text-secondary);
        margin-bottom: 0.25rem;
    }
    
    .stat-value {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--text-main);
    }
    
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: var(--text-secondary);
    }
    
    .empty-state .material-icons {
        font-size: 64px;
        margin-bottom: 1rem;
        opacity: 0.3;
    }
    
    @media (max-width: 768px) {
        .comparison-selects {
            grid-template-columns: 1fr;
        }
        
        .comparison-icon {
            transform: rotate(90deg);
        }
        
        .comparison-headers,
        .comparison-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

{% if comparison_data %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
    // Parse comparison data
    const comparisonData = JSON.parse('{{ comparison_data|safe }}');
    
    // Update stat cards
    document.getElementById('commonWordsCount').textContent = comparisonData.similarity.common_words.toLocaleString('tr-TR');
    document.getElementById('commonLemmasCount').textContent = comparisonData.similarity.common_lemmas.toLocaleString('tr-TR');
    document.getElementById('wordSimilarity').textContent = (comparisonData.similarity.jaccard_words * 100).toFixed(1) + '%';
    document.getElementById('lemmaSimilarity').textContent = (comparisonData.similarity.jaccard_lemmas * 100).toFixed(1) + '%';
    
    // Chart.js configuration
    Chart.defaults.color = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim();
    Chart.defaults.borderColor = getComputedStyle(document.documentElement).getPropertyValue('--border-subtle').trim();
    
    // Theme colors
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    const colors = {
        doc1: isDark ? '#3b82f6' : '#0284c7',
        doc2: isDark ? '#10b981' : '#059669',
        background1: isDark ? 'rgba(59, 130, 246, 0.2)' : 'rgba(2, 132, 199, 0.2)',
        background2: isDark ? 'rgba(16, 185, 129, 0.2)' : 'rgba(5, 150, 105, 0.2)'
    };
    
    // 1. Basic Stats Chart (Grouped Bar)
    new Chart(document.getElementById('basicStatsChart'), {
        type: 'bar',
        data: {
            labels: ['Toplam Kelime', 'Benzersiz Kelime', 'Benzersiz Kök', 'POS Etiket'],
            datasets: [{
                label: '{{ doc1.title|truncatechars:30 }}',
                data: [
                    comparisonData.basic_stats.doc1.total_words,
                    comparisonData.basic_stats.doc1.unique_words,
                    comparisonData.basic_stats.doc1.unique_lemmas,
                    comparisonData.basic_stats.doc1.pos_tags
                ],
                backgroundColor: colors.background1,
                borderColor: colors.doc1,
                borderWidth: 2
            }, {
                label: '{{ doc2.title|truncatechars:30 }}',
                data: [
                    comparisonData.basic_stats.doc2.total_words,
                    comparisonData.basic_stats.doc2.unique_words,
                    comparisonData.basic_stats.doc2.unique_lemmas,
                    comparisonData.basic_stats.doc2.pos_tags
                ],
                backgroundColor: colors.background2,
                borderColor: colors.doc2,
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: true, position: 'top' },
                tooltip: {
                    callbacks: {
                        label: ctx => `${ctx.dataset.label}: ${ctx.parsed.y.toLocaleString('tr-TR')}`
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: { callback: value => value.toLocaleString('tr-TR') }
                }
            }
        }
    });
    
    // 2. Common Words Chart
    const commonWordsData = comparisonData.top_common_words;
    new Chart(document.getElementById('commonWordsChart'), {
        type: 'bar',
        data: {
            labels: Object.keys(commonWordsData),
            datasets: [{
                label: 'Toplam Frekans',
                data: Object.values(commonWordsData),
                backgroundColor: isDark ? 'rgba(168, 85, 247, 0.6)' : 'rgba(147, 51, 234, 0.6)',
                borderColor: isDark ? '#a855f7' : '#9333ea',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: ctx => `Frekans: ${ctx.parsed.x.toLocaleString('tr-TR')}`
                    }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: { callback: value => value.toLocaleString('tr-TR') }
                }
            }
        }
    });
    
    // 3. Unique Words 1
    const uniqueWords1Data = comparisonData.top_unique_words1;
    new Chart(document.getElementById('uniqueWords1Chart'), {
        type: 'bar',
        data: {
            labels: Object.keys(uniqueWords1Data),
            datasets: [{
                label: 'Frekans',
                data: Object.values(uniqueWords1Data),
                backgroundColor: colors.background1,
                borderColor: colors.doc1,
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: ctx => `Frekans: ${ctx.parsed.x.toLocaleString('tr-TR')}`
                    }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: { callback: value => value.toLocaleString('tr-TR') }
                }
            }
        }
    });
    
    // 4. Unique Words 2
    const uniqueWords2Data = comparisonData.top_unique_words2;
    new Chart(document.getElementById('uniqueWords2Chart'), {
        type: 'bar',
        data: {
            labels: Object.keys(uniqueWords2Data),
            datasets: [{
                label: 'Frekans',
                data: Object.values(uniqueWords2Data),
                backgroundColor: colors.background2,
                borderColor: colors.doc2,
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: ctx => `Frekans: ${ctx.parsed.x.toLocaleString('tr-TR')}`
                    }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: { callback: value => value.toLocaleString('tr-TR') }
                }
            }
        }
    });
    
    // 5. POS Distribution Comparison
    const posLabels = [...new Set([
        ...Object.keys(comparisonData.pos_distribution1),
        ...Object.keys(comparisonData.pos_distribution2)
    ])];
    
    new Chart(document.getElementById('posComparisonChart'), {
        type: 'radar',
        data: {
            labels: posLabels,
            datasets: [{
                label: '{{ doc1.title|truncatechars:30 }}',
                data: posLabels.map(label => comparisonData.pos_distribution1[label] || 0),
                backgroundColor: colors.background1,
                borderColor: colors.doc1,
                borderWidth: 2
            }, {
                label: '{{ doc2.title|truncatechars:30 }}',
                data: posLabels.map(label => comparisonData.pos_distribution2[label] || 0),
                backgroundColor: colors.background2,
                borderColor: colors.doc2,
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: true, position: 'top' },
                tooltip: {
                    callbacks: {
                        label: ctx => `${ctx.dataset.label}: ${ctx.parsed.r.toLocaleString('tr-TR')}`
                    }
                }
            },
            scales: {
                r: {
                    beginAtZero: true,
                    ticks: { callback: value => value.toLocaleString('tr-TR') }
                }
            }
        }
    });
</script>
{% endif %}

{% endblock %}
