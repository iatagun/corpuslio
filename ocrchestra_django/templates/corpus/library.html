{% extends "corpus/base.html" %}

{% block title %}Kütüphane - CorpusIO{% endblock %}

{% block content %}
<div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1.5rem;">
    <h2><span class="material-icons" style="vertical-align:middle; margin-right:0.5rem;">library_books</span> Mevcut Kitaplar</h2>
    <span class="badge" style="background:var(--bg-surface); color:var(--text-secondary);">
        {{ page_obj.paginator.count }} doküman
    </span>
</div>

<!-- Search and Filters -->
<div class="card filter-section">
    <form method="GET" class="filter-form">
        <div class="filter-grid">
            <input type="text" name="q" value="{{ request.GET.q }}" placeholder="Dosya adı, yazar..."
                class="form-control">

            <input type="text" name="author" value="{{ request.GET.author }}" placeholder="Yazar" class="form-control">

            <select name="genre" class="form-control" id="genreSelect">
                <option value="">-- Tür --</option>
                {% for genre in all_genres %}
                <option value="{{ genre }}">{{ genre|title }}</option>
                {% endfor %}
            </select>
            <script>
                // Set selected genre from URL parameter (Robust Solution)
                document.addEventListener('DOMContentLoaded', function () {
                    const urlParams = new URLSearchParams(window.location.search);
                    const genre = urlParams.get('genre');
                    if (genre) {
                        const select = document.getElementById('genreSelect');
                        // Find option with specific value
                        for (let i = 0; i < select.options.length; i++) {
                            if (select.options[i].value === genre) {
                                select.selectedIndex = i;
                                break;
                            }
                        }
                    }
                });
            </script>

            <input type="text" name="date" value="{{ request.GET.date }}" placeholder="Tarih" class="form-control">

            <button type="submit" class="btn btn-primary">Filtrele</button>
            <a href="{% url 'corpus:library' %}" class="btn btn-outline" style="text-align:center;">Temizle</a>
        </div>
    </form>
</div>

{% if documents %}
<div class="documents-grid" id="documentsGrid">
    {% for doc in documents %}
    <div class="card document-card">
        <h3>{{ doc.filename }}</h3>
        <p class="meta">
            <span class="format-badge">{{ doc.format }}</span>
            <span class="date" style="display:flex; align-items:center; gap:0.25rem;">
                <span class="material-icons" style="font-size:14px;">calendar_today</span>
                {{ doc.upload_date|date:"d.m.Y" }}
            </span>
        </p>

        <p class="status">
            {% if doc.processed %}
            <span
                style="display:flex; align-items:center; gap:0.25rem; color:var(--accent-success); font-weight:500; font-size:0.85rem;">
                <span class="material-icons" style="font-size:16px;">check_circle</span> İşlendi
            </span>
            <span class="word-count">{{ doc.get_word_count }} kelime</span>
            {% else %}
            <span
                style="display:flex; align-items:center; gap:0.25rem; color:var(--text-secondary); font-size:0.85rem;">
                <span class="material-icons" style="font-size:16px;">hourglass_empty</span> Bekliyor
            </span>
            {% endif %}
        </p>

        <div class="actions">
            {% if doc.processed %}
            <a href="{% url 'corpus:analysis' doc.id %}" class="btn btn-secondary btn-small">İncele</a>
            <a href="{% url 'corpus:export' doc.id %}?format=vrt" class="btn btn-outline btn-small">VRT</a>
            {% endif %}
            {% load auth_extras %}
            {% if request.user|has_group:"Academician" or request.user|has_group:"Developer" or request.user.is_superuser %}
            <form method="POST" action="{% url 'corpus:delete' doc.id %}" style="display:inline;"
                onsubmit="return confirm('Silmek istediğinize emin misiniz?');">
                {% csrf_token %}
                <button type="submit" class="btn btn-small btn-danger" style="border:none;">
                    <span class="material-icons" style="font-size:16px;">delete</span>
                </button>
            </form>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<!-- Loading indicator for infinite scroll -->
<div id="infiniteScrollLoader" 
     class="infinite-scroll-loader" 
     style="display: none;"
     data-current-page="{{ page_obj.number }}"
     data-total-pages="{{ page_obj.paginator.num_pages }}"
     data-has-more="{{ page_obj.has_next|yesno:'true,false' }}">
    <div class="spinner-small"></div>
    <p style="color: var(--text-secondary); margin-top: 0.5rem;">Daha fazla yükleniyor...</p>
</div>

<!-- End of results indicator -->
<div id="endOfResults" class="end-of-results" style="display: none;">
    <span class="material-icons" style="font-size: 2rem; color: var(--text-tertiary);">check_circle</span>
    <p style="color: var(--text-secondary); margin-top: 0.5rem;">Tüm dokümanlar yüklendi</p>
</div>

{% else %}
<!-- Skeleton Loading (initially hidden, shown via JS when loading) -->
<div class="documents-grid" id="skeletonGrid" style="display: none;">
    <div class="skeleton-card">
        <div class="skeleton skeleton-text-lg" style="width: 70%; margin-bottom: 1rem;"></div>
        <div class="skeleton skeleton-text" style="width: 30%; margin-bottom: 0.5rem;"></div>
        <div class="skeleton skeleton-text" style="width: 50%; margin-bottom: 1rem;"></div>
        <div style="display: flex; gap: 0.5rem;">
            <div class="skeleton skeleton-text" style="width: 80px; height: 36px;"></div>
            <div class="skeleton skeleton-text" style="width: 80px; height: 36px;"></div>
        </div>
    </div>
    <div class="skeleton-card">
        <div class="skeleton skeleton-text-lg" style="width: 60%; margin-bottom: 1rem;"></div>
        <div class="skeleton skeleton-text" style="width: 40%; margin-bottom: 0.5rem;"></div>
        <div class="skeleton skeleton-text" style="width: 45%; margin-bottom: 1rem;"></div>
        <div style="display: flex; gap: 0.5rem;">
            <div class="skeleton skeleton-text" style="width: 80px; height: 36px;"></div>
            <div class="skeleton skeleton-text" style="width: 80px; height: 36px;"></div>
        </div>
    </div>
    <div class="skeleton-card">
        <div class="skeleton skeleton-text-lg" style="width: 75%; margin-bottom: 1rem;"></div>
        <div class="skeleton skeleton-text" style="width: 35%; margin-bottom: 0.5rem;"></div>
        <div class="skeleton skeleton-text" style="width: 55%; margin-bottom: 1rem;"></div>
        <div style="display: flex; gap: 0.5rem;">
            <div class="skeleton skeleton-text" style="width: 80px; height: 36px;"></div>
            <div class="skeleton skeleton-text" style="width: 80px; height: 36px;"></div>
        </div>
    </div>
</div>

<div class="alert alert-info" style="display:flex; align-items:center; gap:0.5rem;">
    <span class="material-icons">info</span>
    <p>Kütüphane boş. 'Yeni Ekle' sekmesinden kitap ekleyebilirsiniz.</p>
</div>
{% endif %}

<style>
    .documents-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 1.5rem;
    }

    .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        align-items: center;
    }

    .infinite-scroll-loader,
    .end-of-results {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 2rem;
        margin: 2rem 0;
    }
</style>
<script>
    // ========================================
    // INFINITE SCROLL IMPLEMENTATION
    // ========================================
    
    // Get initial values from data attributes
    const loaderElement = document.getElementById('infiniteScrollLoader');
    let currentPage = parseInt(loaderElement.dataset.currentPage);
    let totalPages = parseInt(loaderElement.dataset.totalPages);
    let isLoading = false;
    let hasMore = loaderElement.dataset.hasMore === 'true';

    // Get current filter parameters
    function getCurrentFilters() {
        const params = new URLSearchParams(window.location.search);
        return {
            q: params.get('q') || '',
            author: params.get('author') || '',
            genre: params.get('genre') || '',
            date: params.get('date') || ''
        };
    }

    // Build query string from filters
    function buildQueryString(page) {
        const filters = getCurrentFilters();
        const params = new URLSearchParams();
        
        params.append('page', page);
        if (filters.q) params.append('q', filters.q);
        if (filters.author) params.append('author', filters.author);
        if (filters.genre) params.append('genre', filters.genre);
        if (filters.date) params.append('date', filters.date);
        
        return params.toString();
    }

    // Load more documents
    function loadMoreDocuments() {
        if (isLoading || !hasMore) return;
        
        isLoading = true;
        const loader = document.getElementById('infiniteScrollLoader');
        loader.style.display = 'flex';
        
        const nextPage = currentPage + 1;
        const queryString = buildQueryString(nextPage);
        
        fetch(`/corpus/library/?${queryString}`, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.documents && data.documents.length > 0) {
                appendDocuments(data.documents);
                currentPage = data.page;
                hasMore = data.has_next;
                
                if (!hasMore) {
                    showEndOfResults();
                }
            } else {
                hasMore = false;
                showEndOfResults();
            }
        })
        .catch(error => {
            console.error('Error loading documents:', error);
            toastError('Dokümanlar yüklenirken bir hata oluştu');
        })
        .finally(() => {
            loader.style.display = 'none';
            isLoading = false;
        });
    }

    // Append documents to grid
    function appendDocuments(documents) {
        const grid = document.getElementById('documentsGrid');
        
        documents.forEach(doc => {
            const card = createDocumentCard(doc);
            grid.appendChild(card);
        });
    }

    // Create document card element
    function createDocumentCard(doc) {
        const card = document.createElement('div');
        card.className = 'card document-card';
        
        const processedBadge = doc.processed
            ? `<span style="display:flex; align-items:center; gap:0.25rem; color:var(--accent-success); font-weight:500; font-size:0.85rem;">
                   <span class="material-icons" style="font-size:16px;">check_circle</span> İşlendi
               </span>
               <span class="word-count">${doc.word_count} kelime</span>`
            : `<span style="display:flex; align-items:center; gap:0.25rem; color:var(--text-secondary); font-size:0.85rem;">
                   <span class="material-icons" style="font-size:16px;">hourglass_empty</span> Bekliyor
               </span>`;
        
        const actions = doc.processed
            ? `<a href="${doc.url}" class="btn btn-secondary btn-small">İncele</a>
               <a href="${doc.export_url}?format=vrt" class="btn btn-outline btn-small">VRT</a>`
            : '';
        
        card.innerHTML = `
            <h3>${doc.title}</h3>
            <p class="meta">
                <span class="format-badge">${doc.filename.split('.').pop().toUpperCase()}</span>
                <span class="date" style="display:flex; align-items:center; gap:0.25rem;">
                    <span class="material-icons" style="font-size:14px;">calendar_today</span>
                    ${doc.upload_date}
                </span>
            </p>
            <p class="status">
                ${processedBadge}
            </p>
            <div class="actions">
                ${actions}
            </div>
        `;
        
        return card;
    }

    // Show end of results message
    function showEndOfResults() {
        const endMessage = document.getElementById('endOfResults');
        endMessage.style.display = 'flex';
    }

    // Intersection Observer for infinite scroll
    function setupInfiniteScroll() {
        const loader = document.getElementById('infiniteScrollLoader');
        
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting && hasMore && !isLoading) {
                    loadMoreDocuments();
                }
            });
        }, {
            root: null,
            rootMargin: '200px', // Start loading 200px before reaching the bottom
            threshold: 0
        });
        
        observer.observe(loader);
    }

    // Initialize infinite scroll on page load
    document.addEventListener('DOMContentLoaded', function() {
        if (hasMore) {
            setupInfiniteScroll();
        } else {
            showEndOfResults();
        }
    });

    // Auto-submit form when select changes (optional)
    document.querySelector('select[name="genre"]').addEventListener('change', function () {
        this.form.submit();
    });
</script>
{% endblock %}