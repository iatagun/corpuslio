{% extends 'base.html' %}
{% load static %}

{% block title %}Advanced Search - OCRchestra{% endblock %}

{% block extra_css %}
<style>
    .advanced-search-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .search-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 10px;
        margin-bottom: 30px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .search-header h1 {
        margin: 0 0 10px 0;
        font-size: 2em;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .search-form-section {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }
    
    .query-input-group {
        margin-bottom: 20px;
    }
    
    .query-input-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 10px;
        color: #333;
    }
    
    .query-input-wrapper {
        position: relative;
    }
    
    .query-input {
        width: 100%;
        padding: 15px;
        font-size: 1.1em;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-family: 'Courier New', monospace;
        transition: border-color 0.3s;
    }
    
    .query-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .query-validation {
        margin-top: 10px;
        padding: 10px;
        border-radius: 5px;
        font-size: 0.9em;
    }
    
    .query-validation.valid {
        background: #d1fae5;
        color: #065f46;
        border: 1px solid #10b981;
    }
    
    .query-validation.invalid {
  background: #fee2e2;
        color: #991b1b;
        border: 1px solid #ef4444;
    }
    
    .search-options {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }
    
    .option-group label {
        display: block;
        font-weight: 500;
        margin-bottom: 5px;
        color: #666;
    }
    
    .option-group input,
    .option-group select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
    }
    
    .search-actions {
        display: flex;
        gap: 15px;
        align-items: center;
    }
    
    .btn-search {
        padding: 12px 30px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1.1em;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .btn-search:hover {
        background: #5568d3;
    }
    
    .btn-help {
        padding: 12px 20px;
        background: white;
        color: #667eea;
        border: 2px solid #667eea;
        border-radius: 8px;
        font-weight: 600;
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.2s;
    }
    
    .btn-help:hover {
        background: #667eea;
        color: white;
    }
    
    .examples-section {
        background: #f9fafb;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    .examples-section h3 {
        margin: 0 0 15px 0;
        color: #333;
    }
    
    .examples-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 10px;
    }
    
    .example-item {
        background: white;
        padding: 12px;
        border-radius: 5px;
        border: 1px solid #e5e7eb;
        cursor: pointer;
        transition: all 0.2s;
    }
    
    .example-item:hover {
        border-color: #667eea;
        box-shadow: 0 2px 4px rgba(102, 126, 234, 0.1);
    }
    
    .example-query {
        font-family: 'Courier New', monospace;
        color: #667eea;
        font-weight: 600;
        margin-bottom: 5px;
    }
    
    .example-description {
        font-size: 0.85em;
        color: #666;
    }
    
    .results-section {
        background: white;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        overflow: hidden;
    }
    
    .results-header {
        background: #f8f9fa;
        padding: 20px;
        border-bottom: 2px solid #e5e7eb;
    }
    
    .results-header h2 {
        margin: 0;
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .results-stats {
        display: flex;
        gap: 20px;
        margin-top: 10px;
        font-size: 0.9em;
        color: #666;
    }
    
    .stat-item {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .concordance-list {
        padding: 20px;
    }
    
    .concordance-item {
        padding: 15px;
        border-bottom: 1px solid #e5e7eb;
        transition: background 0.2s;
    }
    
    .concordance-item:hover {
        background: #f9fafb;
    }
    
    .concordance-item:last-child {
        border-bottom: none;
    }
    
    .concordance-text {
        font-family: 'Courier New', monospace;
        line-height: 1.8;
        margin-bottom: 10px;
    }
    
    .context-left {
        color: #666;
    }
    
    .match-highlight {
        background: #fef3c7;
        padding: 2px 4px;
        border-radius: 3px;
        font-weight: 600;
        color: #92400e;
    }
    
    .context-right {
        color: #666;
    }
    
    .concordance-meta {
        display: flex;
        gap: 15px;
        font-size: 0.85em;
        color: #999;
    }
    
    .meta-item {
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .empty-results {
        padding: 60px 20px;
        text-align: center;
        color: #999;
    }
    
    .empty-results .material-icons {
        font-size: 4em;
        opacity: 0.3;
        margin-bottom: 15px;
    }
    
    @media (max-width: 768px) {
        .search-options {
            grid-template-columns: 1fr;
        }
        
        .examples-grid {
            grid-template-columns: 1fr;
        }
        
        .search-actions {
            flex-direction: column;
            align-items: stretch;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="advanced-search-container">
    <!-- Header -->
    <div class="search-header">
        <h1>
            <span class="material-icons" style="font-size: 1.2em;">manage_search</span>
            Advanced Pattern Search
        </h1>
        <p>CQP-style corpus query processor for complex pattern matching</p>
    </div>
    
    <!-- Search Form -->
    <div class="search-form-section">
        <form method="post">
            {% csrf_token %}
            
            <div class="query-input-group">
                <label for="query">
                    <span class="material-icons" style="vertical-align: middle;">code</span>
                    CQP Query Pattern
                </label>
                <div class="query-input-wrapper">
                    <input 
                        type="text" 
                        id="query" 
                        name="query" 
                        class="query-input"
                        placeholder='[pos="ADJ"] [pos="NOUN"]'
                        value="{{ query }}"
                        autocomplete="off"
                    >
                </div>
                <div id="queryValidation" class="query-validation" style="display: none;"></div>
            </div>
            
            <div class="search-options">
                <div class="option-group">
                    <label for="context_size">Context Size</label>
                    <select name="context_size" id="context_size">
                        <option value="3">3 words</option>
                        <option value="5" selected>5 words</option>
                        <option value="7">7 words</option>
                        <option value="10">10 words</option>
                    </select>
                </div>
                
                <div class="option-group">
                    <label for="document_id">Search In</label>
                    <select name="document_id" id="document_id">
                        <option value="">All accessible documents</option>
                        <!-- Could be populated with user's documents -->
                    </select>
                </div>
            </div>
            
            <div class="search-actions">
                <button type="submit" class="btn-search">
                    <span class="material-icons">search</span>
                    Search Pattern
                </button>
                <a href="{% url 'corpus:query_syntax_help' %}" class="btn-help" target="_blank">
                    <span class="material-icons">help_outline</span>
                    Query Syntax Help
                </a>
            </div>
        </form>
    </div>
    
    <!-- Examples -->
    <div class="examples-section">
        <h3><span class="material-icons" style="vertical-align: middle;">lightbulb</span> Example Queries</h3>
        <div class="examples-grid">
            {% for example in examples %}
            <div class="example-item" onclick="useExample('{{ example.query }}')">
                <div class="example-query">{{ example.query }}</div>
                <div class="example-description">{{ example.description }}</div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <!-- Query Builder -->
    <div class="search-form-section" style="background: #f9fafb; border: 2px dashed #667eea;">
        <h3 style="margin-top: 0; display: flex; align-items: center; gap: 8px;">
            <span class="material-icons">build</span>
            Visual Query Builder
        </h3>
        <p style="color: #666; margin-bottom: 20px;">Build queries visually without typing CQP syntax</p>
        
        <div id="queryBuilder">
            <div class="builder-token" style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 10px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;">
                    <div>
                        <label style="display: block; font-size: 0.85em; color: #666; margin-bottom: 5px;">Attribute</label>
                        <select id="builder_attr" class="query-input" style="font-size: 0.9em; padding: 8px;">
                            <option value="word">word</option>
                            <option value="lemma">lemma</option>
                            <option value="pos">pos</option>
                        </select>
                    </div>
                    <div>
                        <label style="display: block; font-size: 0.85em; color: #666; margin-bottom: 5px;">Pattern</label>
                        <input type="text" id="builder_pattern" class="query-input" style="font-size: 0.9em; padding: 8px;" placeholder="test">
                    </div>
                    <div style="display: flex; align-items: end;">
                        <button type="button" onclick="addBuilderToken()" style="padding: 8px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; width: 100%;">
                            Add Token
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="builderTokensList" style="min-height: 50px; background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 10px;">
                <div style="color: #999; text-align: center;">No tokens added yet</div>
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button type="button" onclick="generateQuery()" class="btn-search" style="flex: 1;">
                    <span class="material-icons">auto_awesome</span>
                    Generate Query
                </button>
                <button type="button" onclick="clearBuilder()" class="btn-help" style="background: white; flex: 0;">
                    <span class="material-icons">clear</span>
                    Clear
                </button>
            </div>
        </div>
    </div>
    
    <!-- Results -->
    {% if query %}
    <div class="results-section">
        <div class="results-header">
            <h2>
                <span class="material-icons">list_alt</span>
                Search Results
            </h2>
            <div class="results-stats">
                <div class="stat-item">
                    <span class="material-icons" style="font-size: 1.2em;">check_circle</span>
                    <strong>{{ total_matches }}</strong> matches
                </div>
                {% if query_info %}
                <div class="stat-item">
                    <span class="material-icons" style="font-size: 1.2em;">view_module</span>
                    {{ query_info.token_count }} token(s)
                </div>
                <div class="stat-item">
                    <span class="material-icons" style="font-size: 1.2em;">label</span>
                    {{ query_info.attributes_used|join:", " }}
                </div>
                {% endif %}
            </div>
        </div>
        
        <div class="concordance-list">
            {% if results %}
                {% for match in results %}
                <div class="concordance-item">
                    <div class="concordance-text">
                        <span class="context-left">{{ match.left_context_text }}</span>
                        <span class="match-highlight">{{ match.match_text }}</span>
                        <span class="context-right">{{ match.right_context_text }}</span>
                    </div>
                    <div class="concordance-meta">
                        <div class="meta-item">
                            <span class="material-icons" style="font-size: 1em;">description</span>
                            {{ match.document.title }}
                        </div>
                        <div class="meta-item">
                            <span class="material-icons" style="font-size: 1em;">pin_drop</span>
                            Position: {{ match.position }}
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="empty-results">
                    <span class="material-icons">search_off</span>
                    <h3>No matches found</h3>
                    <p>Try a different pattern or check the syntax</p>
                </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
    let builderTokens = [];
    
    function useExample(query) {
        document.getElementById('query').value = query;
        document.getElementById('query').focus();
        validateQuery(query);
    }
    
    function validateQuery(query) {
        const validationDiv = document.getElementById('queryValidation');
        
        if (!query.trim()) {
            validationDiv.style.display = 'none';
            return;
        }
        
        // Simple client-side validation (could be enhanced with AJAX call)
        const hasSquareBrackets = query.includes('[') && query.includes(']');
        const hasAttribute = /(?:word|lemma|pos)=/.test(query);
        
        if (hasSquareBrackets && hasAttribute) {
            validationDiv.className = 'query-validation valid';
            validationDiv.innerHTML = '<span class="material-icons" style="vertical-align: middle; font-size: 1em;">check_circle</span> Valid query syntax';
            validationDiv.style.display = 'block';
        } else {
            validationDiv.className = 'query-validation invalid';
            validationDiv.innerHTML = '<span class="material-icons" style="vertical-align: middle; font-size: 1em;">error</span> Use format: [attribute="value"]';
            validationDiv.style.display = 'block';
        }
    }
    
    function addBuilderToken() {
        const attr = document.getElementById('builder_attr').value;
        const pattern = document.getElementById('builder_pattern').value.trim();
        
        if (!pattern) {
            alert('Please enter a pattern');
            return;
        }
        
        builderTokens.push({ attr: attr, pattern: pattern });
        updateBuilderDisplay();
        
        // Clear pattern input
        document.getElementById('builder_pattern').value = '';
        document.getElementById('builder_pattern').focus();
    }
    
    function removeBuilderToken(index) {
        builderTokens.splice(index, 1);
        updateBuilderDisplay();
    }
    
    function updateBuilderDisplay() {
        const list = document.getElementById('builderTokensList');
        
        if (builderTokens.length === 0) {
            list.innerHTML = '<div style="color: #999; text-align: center;">No tokens added yet</div>';
            return;
        }
        
        let html = '<div style="display: flex; flex-wrap: wrap; gap: 10px;">';
        builderTokens.forEach((token, index) => {
            html += `
                <div style="background: #667eea; color: white; padding: 8px 12px; border-radius: 5px; display: flex; align-items: center; gap: 8px;">
                    <span style="font-family: 'Courier New', monospace;">[${token.attr}="${token.pattern}"]</span>
                    <button type="button" onclick="removeBuilderToken(${index})" style="background: rgba(255,255,255,0.2); border: none; color: white; cursor: pointer; border-radius: 3px; padding: 2px 6px;">
                        <span class="material-icons" style="font-size: 1em;">close</span>
                    </button>
                </div>
            `;
        });
        html += '</div>';
        list.innerHTML = html;
    }
    
    function generateQuery() {
        if (builderTokens.length === 0) {
            alert('Please add at least one token');
            return;
        }
        
        const query = builderTokens.map(t => `[${t.attr}="${t.pattern}"]`).join(' ');
        document.getElementById('query').value = query;
        validateQuery(query);
        
        // Scroll to query input
        document.getElementById('query').scrollIntoView({ behavior: 'smooth', block: 'center' });
        document.getElementById('query').focus();
    }
    
    function clearBuilder() {
        builderTokens = [];
        updateBuilderDisplay();
    }
    
    // Live validation
    document.getElementById('query').addEventListener('input', function(e) {
        validateQuery(e.target.value);
    });
    
    // Initial validation if query present
    window.addEventListener('DOMContentLoaded', function() {
        const query = document.getElementById('query').value;
        if (query) {
            validateQuery(query);
        }
        
        // Allow Enter key in builder pattern input
        document.getElementById('builder_pattern').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addBuilderToken();
            }
        });
    });
</script>
{% endblock %}
