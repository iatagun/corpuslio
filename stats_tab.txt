    # --- TAB 4: STATISTICS ---
    with tab_stats:
        st.header("Derlem İstatistikleri")
        
        # Select Document
        docs = db.get_all_documents()
        processed_docs = [d for d in docs if d['processed']]
        
        if not processed_docs:
            st.warning("Henüz işlenmiş belge yok.")
        else:
            selected_doc_name = st.selectbox(
                "Belge Seçin", 
                [f"{d['id']}: {d['filename']}" for d in processed_docs],
                key="stats_doc_select"
            )
            
            if selected_doc_name:
                doc_id = int(selected_doc_name.split(":")[0])
                doc = db.get_document(doc_id)
                
                if doc and doc.get('analysis'):
                    from ocrchestra.statistics import CorpusStatistics
                    import plotly.express as px
                    import plotly.graph_objects as go
                    import pandas as pd
                    
                    stats = CorpusStatistics(doc['analysis'])
                    
                    # Overview metrics
                    st.subheader("Genel Bakış")
                    col1, col2, col3, col4 = st.columns(4)
                    col1.metric("Token Sayısı", f"{stats.token_count():,}")
                    col2.metric("Tür Sayısı", f"{stats.type_count():,}")
                    col3.metric("TTR", f"{stats.type_token_ratio():.3f}")
                    
                    # Calculate average confidence
                    confidences = [item.get('confidence', 1.0) for item in doc['analysis'] if isinstance(item, dict)]
                    avg_conf = sum(confidences) / len(confidences) if confidences else 0
                    col4.metric("Ort. Güven", f"{avg_conf:.2f}")
                    
                    st.divider()
                    
                    # --- FREQUENCY ANALYSIS ---
                    st.subheader("Frekans Analizi")
                    
                    freq_tab1, freq_tab2, freq_tab3 = st.tabs(["Kelime", "Lemma", "POS"])
                    
                    with freq_tab1:
                        top_n = st.slider("Gösterilecek kelime sayısı", 10, 100, 30, key="word_freq_n")
                        word_freq = stats.word_frequency(top_n)
                        
                        if word_freq:
                            df_words = pd.DataFrame(word_freq, columns=['Kelime', 'Frekans'])
                            
                            # Bar chart
                            fig = px.bar(
                                df_words,
                                x='Kelime',
                                y='Frekans',
                                title=f"En Sık {top_n} Kelime",
                                color='Frekans',
                                color_continuous_scale='Blues'
                            )
                            fig.update_layout(
                                xaxis_tickangle=-45,
                                height=500,
                                showlegend=False
                            )
                            st.plotly_chart(fig, use_container_width=True)
                            
                            # Table
                            st.dataframe(df_words, use_container_width=True, hide_index=True)
                    
                    with freq_tab2:
                        top_n_lemma = st.slider("Gösterilecek lemma sayısı", 10, 100, 30, key="lemma_freq_n")
                        lemma_freq = stats.lemma_frequency(top_n_lemma)
                        
                        if lemma_freq:
                            df_lemmas = pd.DataFrame(lemma_freq, columns=['Lemma', 'Frekans'])
                            
                            fig = px.bar(
                                df_lemmas,
                                x='Lemma',
                                y='Frekans',
                                title=f"En Sık {top_n_lemma} Lemma",
                                color='Frekans',
                                color_continuous_scale='Greens'
                            )
                            fig.update_layout(
                                xaxis_tickangle=-45,
                                height=500,
                                showlegend=False
                            )
                            st.plotly_chart(fig, use_container_width=True)
                            
                            st.dataframe(df_lemmas, use_container_width=True, hide_index=True)
                    
                    with freq_tab3:
                        pos_dist = stats.pos_distribution()
                        
                        if pos_dist:
                            df_pos = pd.DataFrame(list(pos_dist.items()), columns=['POS', 'Sayı'])
                            df_pos = df_pos.sort_values('Sayı', ascending=False)
                            
                            # Pie chart
                            fig = px.pie(
                                df_pos,
                                names='POS',
                                values='Sayı',
                                title="POS Dağılımı",
                                color_discrete_sequence=px.colors.qualitative.Set3
                            )
                            st.plotly_chart(fig, use_container_width=True)
                            
                            st.dataframe(df_pos, use_container_width=True, hide_index=True)
                    
                    st.divider()
                    
                    # --- ZIPF DISTRIBUTION ---
                    st.subheader("Zipf Dağılımı")
                    
                    zipf_data = stats.zipf_distribution()
                    if zipf_data:
                        df_zipf = pd.DataFrame(zipf_data, columns=['Sıra', 'Kelime', 'Gözlenen', 'Beklenen'])
                        
                        # Log-log plot
                        fig = go.Figure()
                        fig.add_trace(go.Scatter(
                            x=df_zipf['Sıra'],
                            y=df_zipf['Gözlenen'],
                            mode='markers',
                            name='Gözlenen',
                            marker=dict(color='#3b82f6', size=8)
                        ))
                        fig.add_trace(go.Scatter(
                            x=df_zipf['Sıra'],
                            y=df_zipf['Beklenen'],
                            mode='lines',
                            name='Zipf Kanunu',
                            line=dict(color='#ef4444', dash='dash', width=2)
                        ))
                        
                        fig.update_layout(
                            title="Zipf Dağılımı (Log-Log)",
                            xaxis_title="Sıra",
                            yaxis_title="Frekans",
                            xaxis_type="log",
                            yaxis_type="log",
                            height=500,
                            hovermode='x unified'
                        )
                        st.plotly_chart(fig, use_container_width=True)
                        
                        st.caption("Zipf Kanunu: Kelimelerin frekansı sıralarıyla ters orantılıdır (f ∝ 1/r)")
                    
                    st.divider()
                    
                    # --- N-GRAM ANALYSIS ---
                    st.subheader("N-gram Analizi")
                    
                    col_ng1, col_ng2 = st.columns(2)
                    with col_ng1:
                        n_size = st.selectbox("N-gram boyutu", [2, 3], index=0)
                    with col_ng2:
                        min_freq = st.slider("Minimum frekans", 2, 10, 3)
                    
                    ngrams = stats.extract_ngrams(n=n_size, min_freq=min_freq)
                    
                    if ngrams:
                        # Calculate collocation scores
                        if n_size == 2:
                            pmi_scores = stats.calculate_pmi(ngrams[:50])
                            tscore_scores = stats.calculate_tscore(ngrams[:50])
                            
                            # Display tabs
                            ng_tab1, ng_tab2, ng_tab3 = st.tabs(["Frekans", "PMI Skoru", "T-score"])
                            
                            with ng_tab1:
                                df_ng = pd.DataFrame([
                                    (' '.join(ng), count) 
                                    for ng, count in ngrams[:30]
                                ], columns=['Bigram', 'Frekans'])
                                
                                fig = px.bar(
                                    df_ng,
                                    x='Bigram',
                                    y='Frekans',
                                    title="En Sık Bigramlar",
                                    color='Frekans',
                                    color_continuous_scale='Purples'
                                )
                                fig.update_layout(xaxis_tickangle=-45, height=500, showlegend=False)
                                st.plotly_chart(fig, use_container_width=True)
                                
                                st.dataframe(df_ng, use_container_width=True, hide_index=True)
                            
                            with ng_tab2:
                                df_pmi = pd.DataFrame([
                                    (' '.join(ng), score)
                                    for ng, score in pmi_scores[:30]
                                ], columns=['Bigram', 'PMI'])
                                
                                fig = px.bar(
                                    df_pmi,
                                    x='Bigram',
                                    y='PMI',
                                    title="PMI (Pointwise Mutual Information)",
                                    color='PMI',
                                    color_continuous_scale='Oranges'
                                )
                                fig.update_layout(xaxis_tickangle=-45, height=500, showlegend=False)
                                st.plotly_chart(fig, use_container_width=True)
                                
                                st.dataframe(df_pmi, use_container_width=True, hide_index=True)
                                st.caption("PMI: Kelimelerin birlikte ortaya çıkma eğilimini ölçer (yüksek = güçlü ilişki)")
                            
                            with ng_tab3:
                                df_tscore = pd.DataFrame([
                                    (' '.join(ng), score)
                                    for ng, score in tscore_scores[:30]
                                ], columns=['Bigram', 'T-score'])
                                
                                fig = px.bar(
                                    df_tscore,
                                    x='Bigram',
                                    y='T-score',
                                    title="T-score (Collocation Strength)",
                                    color='T-score',
                                    color_continuous_scale='Reds'
                                )
                                fig.update_layout(xaxis_tickangle=-45, height=500, showlegend=False)
                                st.plotly_chart(fig, use_container_width=True)
                                
                                st.dataframe(df_tscore, use_container_width=True, hide_index=True)
                                st.caption("T-score: İstatistiksel önemlilik testi (yüksek = anlamlı birliktelik)")
                        
                        else:  # trigrams
                            df_ng = pd.DataFrame([
                                (' '.join(ng), count)
                                for ng, count in ngrams[:30]
                            ], columns=['Trigram', 'Frekans'])
                            
                            fig = px.bar(
                                df_ng,
                                x='Trigram',
                                y='Frekans',
                                title="En Sık Trigramlar",
                                color='Frekans',
                                color_continuous_scale='Viridis'
                            )
                            fig.update_layout(xaxis_tickangle=-45, height=500, showlegend=False)
                            st.plotly_chart(fig, use_container_width=True)
                            
                            st.dataframe(df_ng, use_container_width=True, hide_index=True)
                    else:
                        st.info(f"Minimum {min_freq} frekanslı {n_size}-gram bulunamadı")
                    
                    st.divider()
                    
                    # --- CONFIDENCE DISTRIBUTION ---
                    st.subheader("Güven Skoru Dağılımı")
                    
                    conf_dist = stats.confidence_distribution(bins=10)
                    df_conf = pd.DataFrame(list(conf_dist.items()), columns=['Aralık', 'Sayı'])
                    
                    fig = px.bar(
                        df_conf,
                        x='Aralık',
                        y='Sayı',
                        title="Güven Skoru Dağılımı",
                        color='Sayı',
                        color_continuous_scale='RdYlGn'
                    )
                    fig.update_layout(height=400, showlegend=False)
                    st.plotly_chart(fig, use_container_width=True)
                    
                    st.dataframe(df_conf, use_container_width=True, hide_index=True)
                else:
                    st.info("Bu belge için analiz verisi yok")
