{% extends "corpus/base.html" %}

{% block title %}Dashboard - CorpusIO{% endblock %}

{% block extra_css %}
<style>
    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
    }

    .metrics-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .metric {
        background: var(--bg-surface);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 1.5rem;
        text-align: center;
        transition: all 0.3s ease;
    }

    .metric:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
    }

    .metric-value {
        display: block;
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--accent-primary);
        margin-bottom: 0.5rem;
    }

    .metric-label {
        display: block;
        font-size: 0.875rem;
        color: var(--text-secondary);
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
        gap: 1.5rem;
    }

    .chart-card {
        background: var(--bg-surface);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 1.5rem;
    }

    .chart-card h3 {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
        font-size: 1.125rem;
        color: var(--text-main);
    }

    .chart-container {
        position: relative;
        height: 300px;
    }

    @media (max-width: 768px) {
        .charts-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-header">
    <h2><span class="material-icons" style="vertical-align: middle; margin-right: 0.5rem;">dashboard</span> Korpus Dashboard</h2>
</div>

<!-- Summary Cards -->
<div class="metrics-row">
    <div class="metric">
        <span class="metric-value">{{ total_docs }}</span>
        <span class="metric-label">Toplam Belge</span>
    </div>
    <div class="metric">
        <span class="metric-value">{{ processed_docs }}</span>
        <span class="metric-label">İşlenmiş Belge</span>
    </div>
    <div class="metric">
        <span class="metric-value">{{ processed_docs|default:0 }}</span>
        <span class="metric-label">Aktif Koleksiyon</span>
    </div>
</div>

<!-- Charts Grid -->
<div class="charts-grid">
    <!-- Upload Trend (Time Series) -->
    <div class="chart-card">
        <h3><span class="material-icons">trending_up</span> Yükleme Trendi</h3>
        <div class="chart-container">
            <canvas id="uploadTrendChart"></canvas>
        </div>
    </div>

    <!-- Format Distribution (Pie Chart) -->
    <div class="chart-card">
        <h3><span class="material-icons">donut_large</span> Format Dağılımı</h3>
        <div class="chart-container">
            <canvas id="formatDistChart"></canvas>
        </div>
    </div>

    <!-- Word Count Statistics (Bar Chart) -->
    <div class="chart-card">
        <h3><span class="material-icons">bar_chart</span> Kelime Sayısı İstatistikleri</h3>
        <div class="chart-container">
            <canvas id="wordCountChart"></canvas>
        </div>
    </div>

    <!-- POS Distribution -->
    <div class="chart-card">
        <h3><span class="material-icons">label</span> POS Etiket Dağılımı</h3>
        <div class="chart-container">
            <canvas id="posDistChart"></canvas>
        </div>
    </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
    // Data from Django backend
    const genreData = {{ genre_data|safe }};
    const posData = {{ pos_data|safe }};
    const wordCounts = {{ word_counts|safe }};
    const docLabels = {{ doc_labels|safe }};
    const dateData = {{ date_data|safe }};

    // Chart.js default configuration
    Chart.defaults.font.family = 'Inter, sans-serif';
    Chart.defaults.color = getComputedStyle(document.documentElement).getPropertyValue('--text-secondary').trim();
    
    // Theme-aware colors
    const isDarkTheme = document.documentElement.getAttribute('data-theme') !== 'light';
    
    const chartColors = {
        primary: '#3b82f6',
        secondary: '#8b5cf6',
        success: '#10b981',
        warning: '#f59e0b',
        danger: '#ef4444',
        info: '#0ea5e9',
        purple: '#a855f7',
        pink: '#ec4899'
    };

    const backgroundColors = [
        'rgba(59, 130, 246, 0.8)',
        'rgba(139, 92, 246, 0.8)',
        'rgba(16, 185, 129, 0.8)',
        'rgba(245, 158, 11, 0.8)',
        'rgba(239, 68, 68, 0.8)',
        'rgba(14, 165, 233, 0.8)',
        'rgba(168, 85, 247, 0.8)',
        'rgba(236, 72, 153, 0.8)'
    ];

    const borderColors = [
        'rgb(59, 130, 246)',
        'rgb(139, 92, 246)',
        'rgb(16, 185, 129)',
        'rgb(245, 158, 11)',
        'rgb(239, 68, 68)',
        'rgb(14, 165, 233)',
        'rgb(168, 85, 247)',
        'rgb(236, 72, 153)'
    ];

    // 1. Upload Trend Chart (Line Chart with Time Series)
    const uploadTrendCtx = document.getElementById('uploadTrendChart').getContext('2d');
    new Chart(uploadTrendCtx, {
        type: 'line',
        data: {
            labels: Object.keys(dateData).sort(),
            datasets: [{
                label: 'Yüklenen Belgeler',
                data: Object.keys(dateData).sort().map(key => dateData[key]),
                borderColor: chartColors.primary,
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 5,
                pointHoverRadius: 7,
                pointBackgroundColor: chartColors.primary,
                pointBorderColor: '#fff',
                pointBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        padding: 15
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    borderColor: chartColors.primary,
                    borderWidth: 1,
                    displayColors: false,
                    callbacks: {
                        label: function(context) {
                            return context.parsed.y + ' belge';
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                x: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });

    // 2. Format Distribution (Doughnut Chart)
    const formatDistCtx = document.getElementById('formatDistChart').getContext('2d');
    
    // Calculate format distribution from genre data (as proxy)
    const formatLabels = Object.keys(genreData);
    const formatValues = Object.values(genreData);
    
    new Chart(formatDistCtx, {
        type: 'doughnut',
        data: {
            labels: formatLabels.length > 0 ? formatLabels : ['PDF', 'DOCX', 'TXT'],
            datasets: [{
                data: formatValues.length > 0 ? formatValues : [45, 30, 25],
                backgroundColor: backgroundColors,
                borderColor: borderColors,
                borderWidth: 2,
                hoverOffset: 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        usePointStyle: true,
                        padding: 15,
                        font: {
                            size: 12
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                            return context.label + ': ' + context.parsed + ' (' + percentage + '%)';
                        }
                    }
                }
            }
        }
    });

    // 3. Word Count Statistics (Horizontal Bar Chart)
    const wordCountCtx = document.getElementById('wordCountChart').getContext('2d');
    new Chart(wordCountCtx, {
        type: 'bar',
        data: {
            labels: docLabels.length > 0 ? docLabels : ['Belge 1', 'Belge 2', 'Belge 3'],
            datasets: [{
                label: 'Kelime Sayısı',
                data: wordCounts.length > 0 ? wordCounts : [1200, 2500, 1800],
                backgroundColor: backgroundColors[2],
                borderColor: borderColors[2],
                borderWidth: 2,
                borderRadius: 6,
                barThickness: 30
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    callbacks: {
                        label: function(context) {
                            return context.parsed.x.toLocaleString('tr-TR') + ' kelime';
                        }
                    }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value.toLocaleString('tr-TR');
                        }
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                y: {
                    grid: {
                        display: false
                    }
                }
            }
        }
    });

    // 4. POS Distribution (Polar Area Chart)
    const posDistCtx = document.getElementById('posDistChart').getContext('2d');
    
    const posLabels = Object.keys(posData).slice(0, 8); // Top 8
    const posValues = Object.values(posData).slice(0, 8);
    
    new Chart(posDistCtx, {
        type: 'polarArea',
        data: {
            labels: posLabels.length > 0 ? posLabels : ['NOUN', 'VERB', 'ADJ', 'ADV'],
            datasets: [{
                data: posValues.length > 0 ? posValues : [450, 320, 280, 150],
                backgroundColor: backgroundColors,
                borderColor: borderColors,
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        usePointStyle: true,
                        padding: 12,
                        font: {
                            size: 11
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    callbacks: {
                        label: function(context) {
                            return context.label + ': ' + context.parsed.r.toLocaleString('tr-TR');
                        }
                    }
                }
            },
            scales: {
                r: {
                    beginAtZero: true,
                    ticks: {
                        display: false
                    },
                    grid: {
                        color: 'rgba(0, 0, 0, 0.1)'
                    }
                }
            }
        }
    });

    // Update charts on theme change
    document.addEventListener('themeChanged', function() {
        location.reload(); // Simple reload for theme change
    });
</script>
{% endblock %}