{% extends "corpus/base.html" %}

{% block title %}Hesap Silme Talebi{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'corpus:privacy_settings' %}">Gizlilik Ayarları</a></li>
                    <li class="breadcrumb-item active">Hesap Silme</li>
                </ol>
            </nav>
            
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                    <h4 class="mb-0"><i class="fas fa-user-times"></i> Hesap Silme Talebi</h4>
                </div>
                <div class="card-body">
                    {% if messages %}
                        {% for message in messages %}
                        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="close" data-dismiss="alert">
                                <span>&times;</span>
                            </button>
                        </div>
                        {% endfor %}
                    {% endif %}
                    
                    <div class="alert alert-danger">
                        <h5><i class="fas fa-exclamation-triangle"></i> Dikkat: Geri Dönüşü Olmayan İşlem</h5>
                        <p class="mb-0">
                            Bu işlem <strong>geri alınamaz</strong>. Hesabınız ve tüm verileriniz 
                            <strong>kalıcı olarak silinecektir</strong>. Lütfen dikkatli olun!
                        </p>
                    </div>
                    
                    <div class="alert alert-warning">
                        <h6><i class="fas fa-clock"></i> 7 Günlük Bekleme Süresi</h6>
                        <p class="mb-0">
                            Yanlışlıkla silmeleri önlemek için <strong>7 günlük</strong> bir bekleme süresi vardır. 
                            Bu süre içinde talebinizi iptal edebilirsiniz.
                        </p>
                    </div>
                    
                    <h5>Verilerinizin Özeti</h5>
                    <p>Aşağıdaki verileriniz silinecektir:</p>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6><i class="fas fa-file-alt text-primary"></i> Belgeler</h6>
                                    <h3 class="mb-0">{{ documents_count }}</h3>
                                    <small class="text-muted">Yüklediğiniz doküman</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6><i class="fas fa-search text-success"></i> Sorgular</h6>
                                    <h3 class="mb-0">{{ queries_count }}</h3>
                                    <small class="text-muted">Arama ve sorgu kaydı</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6><i class="fas fa-file-export text-warning"></i> İhracatlar</h6>
                                    <h3 class="mb-0">{{ exports_count }}</h3>
                                    <small class="text-muted">Export işlemi</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-light">
                                <div class="card-body">
                                    <h6><i class="fas fa-user text-info"></i> Hesap</h6>
                                    <h3 class="mb-0">1</h3>
                                    <small class="text-muted">Kullanıcı hesabı</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <form method="post" id="deletionForm">
                        {% csrf_token %}
                        
                        <div class="form-group">
                            <label for="deletion_type"><strong>Silme Türü:</strong></label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="deletion_type" id="full_deletion" value="full" checked required>
                                <label class="form-check-label" for="full_deletion">
                                    <strong class="text-danger">Tam Silme</strong> (Önerilen)
                                    <br><small class="text-muted">
                                        Hesap ve tüm veriler kalıcı olarak silinir. 
                                        Veri kurtarma mümkün değildir.
                                    </small>
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="deletion_type" id="anonymize" value="anonymize">
                                <label class="form-check-label" for="anonymize">
                                    <strong>Anonimleştirme</strong>
                                    <br><small class="text-muted">
                                        Kişisel bilgiler silinir, belgeler araştırma bütünlüğü için korunur 
                                        (anonim olarak). Kullanıcı adı: deleted_user_XXX, E-posta: deleted_XXX@anonymous.local
                                    </small>
                                </label>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="reason"><strong>Silme Nedeni:</strong> <span class="text-muted">(İsteğe Bağlı)</span></label>
                            <textarea class="form-control" name="reason" id="reason" rows="3" 
                                      placeholder="Bize hesabınızı neden silmek istediğinizi söyleyebilirsiniz..."></textarea>
                            <small class="form-text text-muted">
                                Bu bilgi hizmetimizi iyileştirmemize yardımcı olur.
                            </small>
                        </div>
                        
                        <div class="alert alert-info">
                            <h6><i class="fas fa-download"></i> Verilerinizi Yedekleyin</h6>
                            <p>
                                Hesabınızı silmeden önce verilerinizi indirmenizi öneririz.
                            </p>
                            <a href="{% url 'corpus:request_data_export' %}" class="btn btn-sm btn-info" target="_blank">
                                <i class="fas fa-download"></i> Verilerimi İndir
                            </a>
                        </div>
                        
                        <hr>
                        
                        <div class="form-group">
                            <label for="confirmation"><strong>Onay:</strong></label>
                            <p>
                                Devam etmek için kullanıcı adınızı (<code>{{ user.username }}</code>) yazın:
                            </p>
                            <input type="text" class="form-control" name="confirmation" id="confirmation" 
                                   placeholder="{{ user.username }}" required autocomplete="off">
                            <small class="form-text text-danger">
                                <i class="fas fa-exclamation-triangle"></i> 
                                Kullanıcı adınızı tam olarak yazmalısınız (büyük/küçük harf duyarlı).
                            </small>
                        </div>
                        
                        <div class="form-group">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="understand" required>
                                <label class="form-check-label" for="understand">
                                    <strong>Tüm uyarıları okudum ve anladım.</strong> 
                                    Hesabımın ve verilerimin <strong>7 gün sonra kalıcı olarak silineceğini</strong> kabul ediyorum.
                                </label>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between mt-4">
                            <a href="{% url 'corpus:privacy_settings' %}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> İptal Et
                            </a>
                            <button type="submit" class="btn btn-danger btn-lg" id="submitBtn" disabled>
                                <i class="fas fa-user-times"></i> Hesabımı Sil (7 Gün Bekleme)
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <div class="card mt-3 border-info">
                <div class="card-body">
                    <h6><i class="fas fa-info-circle"></i> Unutulma Hakkı (KVKK/GDPR)</h6>
                    <p class="mb-0">
                        <small>
                            KVKK ve GDPR kapsamında, kişisel verilerinizin silinmesini talep etme hakkına sahipsiniz. 
                            Bu talep 7 gün içinde işleme alınacaktır. Sorularınız için: 
                            <a href="mailto:privacy@ocrchestra.tr">privacy@ocrchestra.tr</a>
                        </small>
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('deletionForm');
    const confirmationInput = document.getElementById('confirmation');
    const understandCheckbox = document.getElementById('understand');
    const submitBtn = document.getElementById('submitBtn');
    const expectedUsername = '{{ user.username }}';
    
    function validateForm() {
        const isUsernameCorrect = confirmationInput.value === expectedUsername;
        const isChecked = understandCheckbox.checked;
        submitBtn.disabled = !(isUsernameCorrect && isChecked);
    }
    
    confirmationInput.addEventListener('input', validateForm);
    understandCheckbox.addEventListener('change', validateForm);
    
    form.addEventListener('submit', function(e) {
        if (confirmationInput.value !== expectedUsername) {
            e.preventDefault();
            alert('Kullanıcı adı eşleşmiyor! Lütfen tekrar deneyin.');
            return false;
        }
        
        if (!confirm('UYARI: Bu işlem geri alınamaz! Devam etmek istediğinizden emin misiniz?')) {
            e.preventDefault();
            return false;
        }
        
        return true;
    });
});
</script>
{% endblock %}
