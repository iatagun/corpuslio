{% extends "corpus/base.html" %}
{% load static %}

{% block title %}Profilim - CorpusIO{% endblock %}

{% block content %}
<div class="container" style="max-width: 1200px; margin-top: 40px;">
    <div class="profile-header" style="margin-bottom: 2rem;">
        <h1 style="color: var(--text-color); font-size: 2rem; margin-bottom: 0.5rem;">
            ğŸ‘¤ {{ user.get_full_name|default:user.username }}
        </h1>
        <p style="color: var(--muted-color); font-size: 1.1rem;">
            {{ user.email }}
        </p>
    </div>

    <div class="profile-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
        <!-- Role & Status Card -->
        <div class="card">
            <div class="card-header">
                <h2 style="margin: 0; font-size: 1.3rem; color: var(--text-color);">
                    ğŸ¯ Hesap Durumu
                </h2>
            </div>
            <div class="card-body">
                <div style="margin-bottom: 1.5rem;">
                    <label style="color: var(--muted-color); font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">
                        Yetki Seviyesi
                    </label>
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        {% if user.is_superuser %}
                        <span class="role-badge role-admin" style="padding: 0.5rem 1rem; border-radius: 6px; font-weight: 600; font-size: 1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            âš¡ SÃ¼per YÃ¶netici (SÄ±nÄ±rsÄ±z)
                        </span>
                        {% elif profile.role == 'registered' %}
                            <span class="role-badge role-registered" style="padding: 0.5rem 1rem; border-radius: 6px; font-weight: 600; font-size: 1rem;">
                                ğŸ“ KayÄ±tlÄ± KullanÄ±cÄ±
                            </span>
                        {% elif profile.role == 'verified' %}
                            <span class="role-badge role-verified" style="padding: 0.5rem 1rem; border-radius: 6px; font-weight: 600; font-size: 1rem;">
                                âœ… DoÄŸrulanmÄ±ÅŸ AraÅŸtÄ±rmacÄ±
                            </span>
                        {% elif profile.role == 'developer' %}
                            <span class="role-badge role-developer" style="padding: 0.5rem 1rem; border-radius: 6px; font-weight: 600; font-size: 1rem;">
                                ğŸ’» GeliÅŸtirici
                            </span>
                        {% elif profile.role == 'admin' %}
                            <span class="role-badge role-admin" style="padding: 0.5rem 1rem; border-radius: 6px; font-weight: 600; font-size: 1rem;">
                                âš¡ YÃ¶netici
                            </span>
                        {% endif %}
                    </div>
                </div>

                {% if profile.role == 'verified' or profile.role == 'developer' or profile.role == 'admin' %}
                <div style="margin-bottom: 1.5rem;">
                    <label style="color: var(--muted-color); font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">
                        Kurum
                    </label>
                    <p style="color: var(--text-color); margin: 0;">
                        {{ profile.institution|default:"BelirtilmemiÅŸ" }}
                    </p>
                </div>

                {% if profile.orcid %}
                <div style="margin-bottom: 1.5rem;">
                    <label style="color: var(--muted-color); font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">
                        ORCID
                    </label>
                    <a href="https://orcid.org/{{ profile.orcid }}" target="_blank" style="color: #3b82f6; text-decoration: none;">
                        {{ profile.orcid }}
                    </a>
                </div>
                {% endif %}
                {% endif %}

                <div style="margin-bottom: 0;">
                    <label style="color: var(--muted-color); font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">
                        Ãœyelik Tarihi
                    </label>
                    <p style="color: var(--text-color); margin: 0;">
                        {{ user.date_joined|date:"d F Y" }}
                    </p>
                </div>
            </div>
        </div>

        <!-- Quota Tracking Card -->
        <div class="card">
            <div class="card-header">
                <h2 style="margin: 0; font-size: 1.3rem; color: var(--text-color);">
                    ğŸ“Š KullanÄ±m Ä°statistikleri
                </h2>
            </div>
            <div class="card-body">
                {% if user.is_superuser %}
                <!-- Superuser unlimited notice -->
                <div style="text-align: center; padding: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">â™¾ï¸</div>
                    <h3 style="color: var(--text-color); margin-bottom: 0.5rem;">SÄ±nÄ±rsÄ±z EriÅŸim</h3>
                    <p style="color: var(--muted-color); margin: 0;">
                        SÃ¼per yÃ¶netici olarak tÃ¼m kotalardan muafsÄ±nÄ±z.
                    </p>
                </div>
                {% else %}
                <!-- Query Quota -->
                <div style="margin-bottom: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <label style="color: var(--muted-color); font-size: 0.9rem;">
                            GÃ¼nlÃ¼k Sorgu Limiti
                        </label>
                        <span style="color: var(--text-color); font-weight: 600;">
                            {{ profile.queries_today }} / {% if query_limit %}{{ query_limit }}{% else %}SÄ±nÄ±rsÄ±z{% endif %}
                        </span>
                    </div>
                    {% if query_limit %}
                    <div class="progress-bar" style="background: var(--background-secondary); height: 8px; border-radius: 4px; overflow: hidden;">
                        <div style="background: linear-gradient(90deg, #3b82f6, #2563eb); height: 100%; width: {{ query_percentage }}%; transition: width 0.3s;"></div>
                    </div>
                    {% endif %}
                    <p style="color: var(--muted-color); font-size: 0.85rem; margin-top: 0.5rem; margin-bottom: 0;">
                        SÄ±fÄ±rlanma: YarÄ±n 00:00
                    </p>
                </div>

                <!-- Export Quota -->
                <div style="margin-bottom: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <label style="color: var(--muted-color); font-size: 0.9rem;">
                            AylÄ±k DÄ±ÅŸa Aktarma KotasÄ±
                        </label>
                        <span style="color: var(--text-color); font-weight: 600;">
                            {{ profile.export_used_mb|floatformat:2 }} MB / {{ profile.export_quota_mb }} MB
                        </span>
                    </div>
                    <div class="progress-bar" style="background: var(--background-secondary); height: 8px; border-radius: 4px; overflow: hidden;">
                        <div style="background: linear-gradient(90deg, #10b981, #059669); height: 100%; width: {{ export_percentage }}%; transition: width 0.3s;"></div>
                    </div>
                    <p style="color: var(--muted-color); font-size: 0.85rem; margin-top: 0.5rem; margin-bottom: 0;">
                        SÄ±fÄ±rlanma: {{ profile.export_last_reset|date:"d F Y" }}
                    </p>
                    
                    <!-- Export History Link -->
                    <div style="margin-top: 1rem;">
                        <a href="{% url 'corpus:export_history' %}" 
                           style="display: inline-block; background: #4f46e5; color: white; padding: 0.5rem 1rem; border-radius: 6px; text-decoration: none; font-size: 0.9rem; font-weight: 500; transition: background 0.2s;">
                            ğŸ“¦ Export GeÃ§miÅŸini GÃ¶rÃ¼ntÃ¼le
                        </a>
                    </div>
                </div>

                {% if profile.role == 'developer' or profile.role == 'admin' %}
                <!-- API Calls -->
                <div style="margin-bottom: 0;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <label style="color: var(--muted-color); font-size: 0.9rem;">
                            API Ã‡aÄŸrÄ±larÄ± (BugÃ¼n)
                        </label>
                        <span style="color: var(--text-color); font-weight: 600;">
                            {{ profile.api_calls_today }} / {{ profile.api_quota_daily }}
                        </span>
                    </div>
                    <div class="progress-bar" style="background: var(--background-secondary); height: 8px; border-radius: 4px; overflow: hidden;">
                        <div style="background: linear-gradient(90deg, #f59e0b, #d97706); height: 100%; width: {% widthratio profile.api_calls_today profile.api_quota_daily 100 %}%; transition: width 0.3s;"></div>
                    </div>
                </div>
                {% endif %}
                {% endif %}
            </div>
        </div>
    </div>

    {% if user.is_superuser or profile.role == 'developer' or profile.role == 'admin' %}
    <!-- API Key Card (Developer/Admin only) -->
    <div class="card" style="margin-bottom: 2rem;">
        <div class="card-header">
            <h2 style="margin: 0; font-size: 1.3rem; color: var(--text-color);">
                ğŸ”‘ API EriÅŸim AnahtarÄ±
            </h2>
        </div>
        <div class="card-body">
            {% if profile.api_key %}
            <div style="background: var(--background-secondary); border: 1px solid var(--border-color); border-radius: 6px; padding: 1rem; margin-bottom: 1rem; font-family: 'Courier New', monospace;">
                <code id="api-key" style="color: var(--text-color); word-break: break-all;">{{ profile.api_key }}</code>
            </div>
            <div style="display: flex; gap: 1rem;">
                <button onclick="copyApiKey()" class="btn btn-primary">
                    ğŸ“‹ Kopyala
                </button>
            </div>
            <p style="color: var(--muted-color); font-size: 0.9rem; margin-top: 1rem; margin-bottom: 0;">
                âš ï¸ API anahtarÄ±nÄ±zÄ± gÃ¼venli tutun. BaÅŸkalarÄ±yla paylaÅŸmayÄ±n.
            </p>
            {% else %}
            <p style="color: var(--muted-color); margin-bottom: 1rem;">
                HenÃ¼z API anahtarÄ±nÄ±z oluÅŸturulmamÄ±ÅŸ.
            </p>
            <p style="color: var(--muted-color); font-size: 0.9rem;">
                API anahtarÄ± otoma tik olarak oluÅŸturulacaktÄ±r. LÃ¼tfen yÃ¶neticiye baÅŸvurun.
            </p>
            {% endif %}
        </div>
    </div>
    {% endif %}

    <!-- Recent Activity -->
    <div class="card">
        <div class="card-header">
            <h2 style="margin: 0; font-size: 1.3rem; color: var(--text-color);">
                ğŸ“œ Son Aramalar
            </h2>
        </div>
        <div class="card-body">
            {% if recent_searches %}
            <div class="table-responsive">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 2px solid var(--border-color);">
                            <th style="padding: 0.75rem; text-align: left; color: var(--muted-color); font-weight: 600;">Sorgu</th>
                            <th style="padding: 0.75rem; text-align: left; color: var(--muted-color); font-weight: 600;">Tip</th>
                            <th style="padding: 0.75rem; text-align: left; color: var(--muted-color); font-weight: 600;">SonuÃ§</th>
                            <th style="padding: 0.75rem; text-align: left; color: var(--muted-color); font-weight: 600;">Tarih</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for search in recent_searches %}
                        <tr style="border-bottom: 1px solid var(--border-color);">
                            <td style="padding: 0.75rem; color: var(--text-color);">{{ search.query }}</td>
                            <td style="padding: 0.75rem; color: var(--muted-color);">
                                <span style="background: var(--background-secondary); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.85rem;">
                                    {{ search.search_type }}
                                </span>
                            </td>
                            <td style="padding: 0.75rem; color: var(--text-color);">{{ search.result_count }}</td>
                            <td style="padding: 0.75rem; color: var(--muted-color); font-size: 0.9rem;">
                                {{ search.created_at|date:"d M Y H:i" }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <p style="color: var(--muted-color); text-align: center; padding: 2rem 0; margin: 0;">
                HenÃ¼z arama yapÄ±lmamÄ±ÅŸ.
            </p>
            {% endif %}
        </div>
    </div>

    <!-- Detailed Activity Logs (Query & Export) -->
    <div class="card" style="margin-top: 2rem;">
        <div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
            <h2 style="margin: 0; font-size: 1.3rem; color: var(--text-color);">
                ğŸ” DetaylÄ± Aktivite GeÃ§miÅŸi
            </h2>
            <span style="background: var(--background-secondary); padding: 0.4rem 0.8rem; border-radius: 6px; font-size: 0.85rem; color: var(--muted-color);">
                BugÃ¼n: {{ profile.queries_today }} sorgu, {{ profile.export_used_mb|floatformat:2 }} MB export
                <span style="margin-left: 10px; opacity: 0.7;">
                    ({{ recent_query_logs|length }} log, {{ recent_export_logs|length }} export)
                </span>
            </span>
        </div>
        <div class="card-body">
            {% if recent_query_logs %}
            <h3 style="font-size: 1.1rem; color: var(--text-color); margin-bottom: 1rem; border-bottom: 2px solid var(--border-color); padding-bottom: 0.5rem;">
                ğŸ“Š Son Query LoglarÄ± 
                <span style="font-size: 0.85rem; color: var(--muted-color); font-weight: normal;">
                    (Rate limit edilenler kotaya dahil deÄŸildir)
                </span>
            </h3>
            <div class="table-responsive" style="margin-bottom: 2rem;">
                <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                    <thead>
                        <tr style="border-bottom: 2px solid var(--border-color);">
                            <th style="padding: 0.6rem; text-align: left; color: var(--muted-color); font-weight: 600;">Sorgu</th>
                            <th style="padding: 0.6rem; text-align: left; color: var(--muted-color); font-weight: 600;">Tip</th>
                            <th style="padding: 0.6rem; text-align: center; color: var(--muted-color); font-weight: 600;">SonuÃ§</th>
                            <th style="padding: 0.6rem; text-align: center; color: var(--muted-color); font-weight: 600;">SÃ¼re</th>
                            <th style="padding: 0.6rem; text-align: center; color: var(--muted-color); font-weight: 600;">Durum</th>
                            <th style="padding: 0.6rem; text-align: right; color: var(--muted-color); font-weight: 600;">Tarih</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in recent_query_logs %}
                        <tr style="border-bottom: 1px solid var(--border-color);">
                            <td style="padding: 0.6rem; color: var(--text-color); max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                {{ log.query_text|truncatewords:8 }}
                            </td>
                            <td style="padding: 0.6rem;">
                                <span style="background: #dbeafe; color: #1e40af; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">
                                    {{ log.get_query_type_display|default:"Kelime" }}
                                </span>
                            </td>
                            <td style="padding: 0.6rem; text-align: center; color: var(--text-color);">
                                {{ log.result_count }}
                            </td>
                            <td style="padding: 0.6rem; text-align: center; color: var(--muted-color); font-size: 0.85rem;">
                                {{ log.execution_time_ms }}ms
                            </td>
                            <td style="padding: 0.6rem; text-align: center;">
                                {% if log.rate_limit_hit %}
                                <div>
                                    <span style="background: #fee2e2; color: #dc2626; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.8rem; display: block; margin-bottom: 0.2rem;">
                                        ğŸš« Reddedildi
                                    </span>
                                    <span style="color: #6b7280; font-size: 0.7rem; font-style: italic;">
                                        Kotaya dahil deÄŸil
                                    </span>
                                </div>
                                {% elif log.is_cached %}
                                <div>
                                    <span style="background: #d1fae5; color: #059669; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.8rem; display: block; margin-bottom: 0.2rem;">
                                        âš¡ Cache
                                    </span>
                                    <span style="color: #6b7280; font-size: 0.7rem; font-style: italic;">
                                        Kotaya dahil
                                    </span>
                                </div>
                                {% else %}
                                <div>
                                    <span style="background: #e0e7ff; color: #4f46e5; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.8rem; display: block; margin-bottom: 0.2rem;">
                                        âœ“ BaÅŸarÄ±lÄ±
                                    </span>
                                    <span style="color: #6b7280; font-size: 0.7rem; font-style: italic;">
                                        Kotaya dahil
                                    </span>
                                </div>
                                {% endif %}
                            </td>
                            <td style="padding: 0.6rem; text-align: right; color: var(--muted-color); font-size: 0.85rem;">
                                {{ log.created_at|date:"d.m H:i" }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}

            {% if recent_export_logs %}
            <h3 style="font-size: 1.1rem; color: var(--text-color); margin-bottom: 1rem; border-bottom: 2px solid var(--border-color); padding-bottom: 0.5rem;">
                ğŸ“¦ Son Export LoglarÄ± (Kotaya Dahil)
            </h3>
            <div class="table-responsive">
                <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                    <thead>
                        <tr style="border-bottom: 2px solid var(--border-color);">
                            <th style="padding: 0.6rem; text-align: left; color: var(--muted-color); font-weight: 600;">Tip</th>
                            <th style="padding: 0.6rem; text-align: left; color: var(--muted-color); font-weight: 600;">Format</th>
                            <th style="padding: 0.6rem; text-align: center; color: var(--muted-color); font-weight: 600;">Boyut</th>
                            <th style="padding: 0.6rem; text-align: center; color: var(--muted-color); font-weight: 600;">Kota DeÄŸiÅŸimi</th>
                            <th style="padding: 0.6rem; text-align: center; color: var(--muted-color); font-weight: 600;">Filigran</th>
                            <th style="padding: 0.6rem; text-align: right; color: var(--muted-color); font-weight: 600;">Tarih</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in recent_export_logs %}
                        <tr style="border-bottom: 1px solid var(--border-color);">
                            <td style="padding: 0.6rem;">
                                <span style="background: #fef3c7; color: #92400e; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">
                                    {{ log.get_export_type_display }}
                                </span>
                            </td>
                            <td style="padding: 0.6rem; color: var(--text-color); text-transform: uppercase; font-weight: 600;">
                                {{ log.format }}
                            </td>
                            <td style="padding: 0.6rem; text-align: center; color: var(--text-color); font-weight: 500;">
                                {{ log.file_size_mb|floatformat:2 }} MB
                            </td>
                            <td style="padding: 0.6rem; text-align: center; color: var(--muted-color); font-size: 0.85rem;">
                                {{ log.quota_before_mb|floatformat:2 }} â†’ {{ log.quota_after_mb|floatformat:2 }} MB
                            </td>
                            <td style="padding: 0.6rem; text-align: center;">
                                {% if log.watermark_applied %}
                                <span style="color: #059669;">âœ“</span>
                                {% else %}
                                <span style="color: #dc2626;">âœ—</span>
                                {% endif %}
                            </td>
                            <td style="padding: 0.6rem; text-align: right; color: var(--muted-color); font-size: 0.85rem;">
                                {{ log.created_at|date:"d.m H:i" }}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}

            {% if not recent_query_logs and not recent_export_logs %}
            <div style="text-align: center; padding: 3rem 1rem; background: var(--background-secondary); border-radius: 8px;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ“­</div>
                <h3 style="color: var(--text-color); margin-bottom: 0.5rem;">HenÃ¼z Aktivite Yok</h3>
                <p style="color: var(--muted-color); margin: 0;">
                    Arama yaptÄ±ÄŸÄ±nÄ±zda veya dosya export ettiÄŸinizde aktiviteleriniz burada gÃ¶rÃ¼necek.
                </p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Upgrade CTA (if not max role) -->
    {% if not user.is_superuser and profile.role == 'registered' %}
    <div class="card" style="margin-top: 2rem; background: linear-gradient(135deg, #3b82f6, #2563eb); border: none;">
        <div class="card-body" style="padding: 2rem; text-align: center;">
            <h3 style="color: white; font-size: 1.5rem; margin-bottom: 1rem;">
                âœ¨ Daha Fazla EriÅŸim Ä°Ã§in HesabÄ±nÄ±zÄ± YÃ¼kseltin
            </h3>
            <p style="color: rgba(255,255,255,0.9); margin-bottom: 1.5rem;">
                DoÄŸrulanmÄ±ÅŸ araÅŸtÄ±rmacÄ± olarak gÃ¼nlÃ¼k 1000 sorgu hakkÄ± ve aylÄ±k 100MB dÄ±ÅŸa aktarma kotasÄ± kazanÄ±n.
            </p>
            <a href="mailto:support@corpusio.org?subject=Hesap DoÄŸrulama Talebi" class="btn" style="background: white; color: #3b82f6; padding: 0.75rem 2rem; border-radius: 6px; text-decoration: none; font-weight: 600;">
                BaÅŸvuru Yap â†’
            </a>
        </div>
    </div>
    {% endif %}
</div>

<style>
.role-badge {
    display: inline-block;
}

.role-registered {
    background: #dbeafe;
    color: #1e40af;
}

.role-verified {
    background: #d1fae5;
    color: #065f46;
}

.role-developer {
    background: #fef3c7;
    color: #92400e;
}

.role-admin {
    background: #fce7f3;
    color: #9f1239;
}

.btn {
    padding: 0.5rem 1rem;
    border-radius: 6px;
    border: none;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.2s;
}

.btn-primary {
    background: #3b82f6;
    color: white;
}

.btn-primary:hover {
    background: #2563eb;
    transform: translateY(-1px);
}

.btn-secondary {
    background: var(--background-secondary);
    color: var(--text-color);
    border: 1px solid var(--border-color);
}

.btn-secondary:hover {
    background: var(--background-tertiary);
}

@media (max-width: 768px) {
    .profile-grid {
        grid-template-columns: 1fr !important;
    }
}
</style>

<script>
function copyApiKey() {
    const apiKey = document.getElementById('api-key').textContent;
    navigator.clipboard.writeText(apiKey).then(() => {
        alert('API anahtarÄ± panoya kopyalandÄ±!');
    });
}
</script>
{% endblock %}

