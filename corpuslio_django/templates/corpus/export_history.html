{% extends 'corpus/base.html' %}
{% load static %}

{% block title %}Export History{% endblock %}

{% block extra_head %}
<style>
    /* Responsive Export History Styles */
    .export-quota-stats {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }
    
    .quota-stat-left {
        flex: 1;
    }
    
    .quota-stat-right {
        text-align: right;
    }
    
    /* Desktop Table */
    .export-table-desktop {
        display: block !important;
    }
    
    .export-table-mobile {
        display: none !important;
    }
    
    /* Responsive table headers */
    .th-full {
        display: inline;
    }
    
    .th-short {
        display: none;
    }
    
    /* Tablet screens - compressed headers */
    @media (max-width: 1024px) {
        .export-table-desktop table {
            font-size: 0.8rem;
        }
        
        .export-table-desktop th {
            padding: 0.5rem 0.4rem !important;
            font-size: 0.7rem;
        }
        
        .export-table-desktop td {
            padding: 0.5rem 0.4rem !important;
            font-size: 0.8rem;
        }
        
        /* Show abbreviated headers */
        .th-full {
            display: none;
        }
        
        .th-short {
            display: inline;
        }
        
        /* Compress content for better fit */
        .export-table-desktop .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .export-table-desktop td > div {
            font-size: 0.75rem;
        }
        
        .export-table-desktop td span {
            padding: 0.2rem 0.4rem !important;
            font-size: 0.7rem !important;
        }
        
        /* Shorten document title on tablet */
        .export-table-desktop .doc-title {
            max-width: 100px !important;
        }
        
        /* Card header responsive */
        .card-header {
            padding: 0.75rem !important;
        }
        
        .card-header h2 {
            font-size: 0.95rem !important;
        }
        
        .card-header .material-icons {
            font-size: 1.1rem !important;
        }
    }
    
    /* Mobile Responsive */
    @media (max-width: 768px) {
        .export-quota-stats {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }
        
        .quota-stat-right {
            text-align: left;
            width: 100%;
        }
        
        /* Card header mobile */
        .card-header {
            padding: 0.6rem !important;
        }
        
        .card-header h2 {
            font-size: 0.85rem !important;
            flex-direction: column;
            align-items: flex-start;
            gap: 0.25rem !important;
        }
        
        .card-header .material-icons {
            font-size: 1rem !important;
        }
        
        /* Hide desktop table */
        .export-table-desktop {
            display: none !important;
        }
        
        /* Show mobile cards */
        .export-table-mobile {
            display: block !important;
            padding: 1rem;
        }
        
        .export-card-mobile {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .export-card-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
        }
        
        .export-card-row:last-child {
            border-bottom: none;
        }
        
        .export-card-label {
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            flex-shrink: 0;
            margin-right: 1rem;
        }
        
        .export-card-value {
            text-align: right;
            flex: 1;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container" style="max-width: 1200px; margin: 2rem auto; padding: 0 1rem;">
    <div style="margin-bottom: 2rem;">
        <h1 style="font-size: 2rem; color: var(--text-main); margin-bottom: 0.5rem;">
            üì¶ Export Ge√ßmi≈üi
        </h1>
        <p style="color: var(--text-secondary);">
            Exportlarƒ±nƒ±zƒ± ve kota kullanƒ±mƒ±nƒ±zƒ± takip edin
        </p>
    </div>
    
    <!-- Quota Card -->
    <div class="card" style="margin-bottom: 2rem;">
        <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            <h2 style="margin: 0; font-size: 1.2rem;">
                üíæ Aylƒ±k Export Kotasƒ±
            </h2>
        </div>
        <div class="card-body">
            <div class="export-quota-stats">
                <div class="quota-stat-left">
                    <span style="font-size: 2rem; font-weight: 700; color: {% if quota_percentage >= 90 %}#dc2626{% elif quota_percentage >= 70 %}#f59e0b{% else %}#059669{% endif %};" class="quota-text">
                        {{ quota_used|floatformat:2 }} MB
                    </span>
                    <span style="color: var(--text-secondary); font-size: 1.1rem;">
                        / {{ quota_limit|floatformat:0 }} MB
                    </span>
                </div>
                <div class="quota-stat-right">
                    <div style="font-size: 0.9rem; color: var(--text-secondary);">
                        Kota Kullanƒ±mƒ±
                    </div>
                    <div style="font-size: 1.5rem; font-weight: 600; color: {% if quota_percentage >= 90 %}#dc2626{% elif quota_percentage >= 70 %}#f59e0b{% else %}#059669{% endif %};" class="quota-percent">
                        {{ quota_percentage|floatformat:1 }}%
                    </div>
                </div>
            </div>
            
            <!-- Progress bar -->
            <div style="background: #e5e7eb; height: 20px; border-radius: 10px; overflow: hidden; margin-bottom: 1rem;">
                <div style="height: 100%; 
                            width: {{ quota_percentage|floatformat:1 }}%; 
                            transition: width 0.3s ease;
                            display: flex;
                            align-items: center;
                            justify-content: flex-end;
                            padding-right: 0.5rem; background: {% if quota_percentage >= 90 %}#dc2626{% elif quota_percentage >= 70 %}#f59e0b{% else %}linear-gradient(90deg, #059669, #10b981){% endif %};" >
                    {% if quota_percentage > 10 %}
                    <span style="color: white; font-size: 0.75rem; font-weight: 600;">
                        {{ quota_percentage|floatformat:1 }}%
                    </span>
                    {% endif %}
                </div>
            </div>
            
            <div style="background: #f3f4f6; padding: 0.75rem; border-radius: 6px; font-size: 0.85rem; color: var(--text-secondary);">
                üí° <strong>Kota her ay 1'inde sƒ±fƒ±rlanƒ±r</strong>.
                {% if user.is_superuser %}
                S√ºper kullanƒ±cƒ± olarak <strong>sƒ±nƒ±rsƒ±z</strong> kotaya sahipsiniz.
                {% elif user.userprofile.role == 2 %}
                Doƒürulanmƒ±≈ü ara≈ütƒ±rmacƒ±lar 100 MB/ay kota alƒ±r.
                {% else %}
                Kayƒ±tlƒ± kullanƒ±cƒ±lar 5 MB/ay kota alƒ±r. 100 MB i√ßin <a href="{% url 'corpus:profile' %}" style="color: #4f46e5;">Doƒürulanmƒ±≈ü Ara≈ütƒ±rmacƒ±'ya y√ºkselt</a>.
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- Export History Table -->
    <div class="card">
        <div class="card-header" style="padding: 1rem;">
            <h2 style="margin: 0; font-size: 1.1rem; display: flex; align-items: center; gap: 0.5rem;">
                <span class="material-icons" style="font-size: 1.25rem;">history</span>
                <span>Recent Exports <span style="opacity: 0.7;">(Last 50)</span></span>
            </h2>
        </div>
        <div class="card-body" style="padding: 0;">
            {% if exports %}
            
            <!-- Desktop Table View -->
            <div class="export-table-desktop">
                <div class="table-responsive">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                        <thead>
                            <tr style="border-bottom: 2px solid var(--border-subtle); background: #f9fafb;">
                                <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: var(--text-secondary);">
                                    <span class="th-full">Tarih</span>
                                    <span class="th-short">Tarih</span>
                                </th>
                                <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: var(--text-secondary);">
                                    <span class="th-full">T√ºr</span>
                                    <span class="th-short">T√ºr</span>
                                </th>
                                <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: var(--text-secondary);">
                                    <span class="th-full">Format</span>
                                    <span class="th-short">Fmt</span>
                                </th>
                                <th style="padding: 0.75rem; text-align: left; font-weight: 600; color: var(--text-secondary);">
                                    <span class="th-full">Belge</span>
                                    <span class="th-short">Blg</span>
                                </th>
                                <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: var(--text-secondary);">
                                    <span class="th-full">Boyut</span>
                                    <span class="th-short">MB</span>
                                </th>
                                <th style="padding: 0.75rem; text-align: center; font-weight: 600; color: var(--text-secondary);">
                                    <span class="th-full">Filigran</span>
                                    <span class="th-short">WM</span>
                                </th>
                                <th style="padding: 0.75rem; text-align: right; font-weight: 600; color: var(--text-secondary);">
                                    <span class="th-full">Kota Etkisi</span>
                                    <span class="th-short">Kota</span>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for export in exports %}
                            <tr style="border-bottom: 1px solid var(--border-subtle);">
                                <td style="padding: 0.75rem;">
                                    <div style="font-size: 0.85rem;">{{ export.created_at|date:"M d, Y" }}</div>
                                    <div style="font-size: 0.75rem; color: var(--text-secondary);">{{ export.created_at|time:"H:i" }}</div>
                                </td>
                                <td style="padding: 0.75rem;">
                                    <span style="background: #e0e7ff; color: #4f46e5; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem; font-weight: 500;">
                                        {{ export.export_type|title }}
                                    </span>
                                </td>
                                <td style="padding: 0.75rem;">
                                    <span style="font-family: monospace; background: #f3f4f6; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">
                                        {{ export.format|upper }}
                                    </span>
                                </td>
                                <td style="padding: 0.75rem;">
                                    {% if export.document %}
                                    <div style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" class="doc-title" title="{{ export.document.title }}">
                                        {{ export.document.title }}
                                    </div>
                                    {% else %}
                                    <span style="color: var(--text-secondary); font-style: italic;">Global Search</span>
                                    {% endif %}
                                </td>
                                <td style="padding: 0.75rem; text-align: right; font-family: monospace; color: var(--text-main);">
                                    {{ export.file_size_mb|floatformat:3 }} MB
                                </td>
                                <td style="padding: 0.75rem; text-align: center;">
                                    {% if export.watermark_applied %}
                                    <span style="color: #059669; font-weight: 600;">‚úì</span>
                                    {% else %}
                                    <span style="color: #dc2626; font-weight: 600;">‚úó</span>
                                    {% endif %}
                                </td>
                                <td style="padding: 0.75rem; text-align: right;">
                                    <div style="font-size: 0.85rem;">
                                        <span style="color: #dc2626;">{{ export.quota_before_mb|floatformat:2 }}</span>
                                        ‚Üí
                                        <span style="color: #059669; font-weight: 600;">{{ export.quota_after_mb|floatformat:2 }}</span>
                                    </div>
                                    <div style="font-size: 0.75rem; color: var(--text-secondary);">
                                        (+{{ export.file_size_mb|floatformat:3 }} MB)
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Mobile Card View -->
            <div class="export-table-mobile">
                {% for export in exports %}
                <div class="export-card-mobile">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; padding-bottom: 0.75rem; border-bottom: 2px solid var(--border);">
                        <div>
                            <span style="background: #e0e7ff; color: #4f46e5; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">
                                {{ export.export_type|title }}
                            </span>
                            <span style="font-family: monospace; background: #f3f4f6; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; margin-left: 0.5rem;">
                                {{ export.format|upper }}
                            </span>
                        </div>
                        <div style="text-align: right; font-size: 0.75rem; color: var(--text-secondary);">
                            {{ export.created_at|date:"M d, Y" }}<br>
                            {{ export.created_at|time:"H:i" }}
                        </div>
                    </div>
                    
                    {% if export.document %}
                    <div class="export-card-row">
                        <div class="export-card-label">Belge</div>
                        <div class="export-card-value" style="font-size: 0.85rem; color: var(--text-main);">
                            {{ export.document.title }}
                        </div>
                    </div>
                    {% endif %}
                    
                    <div class="export-card-row">
                        <div class="export-card-label">Boyut</div>
                        <div class="export-card-value" style="font-family: monospace; font-size: 0.9rem; font-weight: 600; color: var(--text-main);">
                            {{ export.file_size_mb|floatformat:3 }} MB
                        </div>
                    </div>
                    
                    <div class="export-card-row">
                        <div class="export-card-label">Filigran</div>
                        <div class="export-card-value">
                            {% if export.watermark_applied %}
                            <span style="color: #059669; font-weight: 600; font-size: 1.2rem;">‚úì Uygulandƒ±</span>
                            {% else %}
                            <span style="color: #dc2626; font-weight: 600; font-size: 1.2rem;">‚úó Yok</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="export-card-row">
                        <div class="export-card-label">Kota Etkisi</div>
                        <div class="export-card-value" style="font-size: 0.85rem;">
                            <span style="color: #dc2626;">{{ export.quota_before_mb|floatformat:2 }}</span>
                            ‚Üí
                            <span style="color: #059669; font-weight: 600;">{{ export.quota_after_mb|floatformat:2 }}</span>
                            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;">
                                (+{{ export.file_size_mb|floatformat:3 }} MB)
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            
            {% else %}
            <div style="padding: 4rem; text-align: center; color: var(--muted-color);">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üì≠</div>
                <p style="font-size: 1.1rem;">Hen√ºz export bulunmuyor</p>
                <p style="font-size: 0.9rem;">Start searching and exporting corpus data!</p>
                <a href="{% url 'corpus:library' %}" 
                   style="display: inline-block; margin-top: 1rem; background: #4f46e5; color: white; padding: 0.75rem 1.5rem; border-radius: 8px; text-decoration: none; font-weight: 500;">
                    Browse Library
                </a>
            </div>
            {% endif %}
        </div>
    </div>
    
    <div style="margin-top: 2rem; text-align: center;">
        <a href="{% url 'corpus:profile' %}" 
           style="color: #4f46e5; text-decoration: none; font-weight: 500;">
            ‚Üê Back to Profile
        </a>
    </div>
</div>
{% endblock %}
<script>
    // Debug overlay + auto-toggle desktop/mobile export views
    (function(){
        try{
            var dbg = document.getElementById('__viewport_debug');
            if(!dbg){
                dbg = document.createElement('div');
                dbg.id = '__viewport_debug';
                dbg.style.position = 'fixed';
                dbg.style.bottom = '8px';
                dbg.style.right = '8px';
                dbg.style.background = 'rgba(0,0,0,0.6)';
                dbg.style.color = '#fff';
                dbg.style.padding = '6px 8px';
                dbg.style.borderRadius = '6px';
                dbg.style.fontSize = '12px';
                dbg.style.zIndex = 99999;
                dbg.style.pointerEvents = 'none';
                document.body.appendChild(dbg);
            }

            var desktop = document.querySelector('.export-table-desktop');
            var mobile = document.querySelector('.export-table-mobile');

            function setView(){
                var w = window.innerWidth || document.documentElement.clientWidth;
                dbg.textContent = 'w:' + w + ' h:' + (window.innerHeight||document.documentElement.clientHeight) + ' dpr:' + (window.devicePixelRatio||1);
                // If viewport is wider than 1024px, force desktop view
                if(w > 1024){
                    if(desktop) desktop.style.setProperty('display','block','important');
                    if(mobile) mobile.style.setProperty('display','none','important');
                } else {
                    if(desktop) desktop.style.setProperty('display','none','important');
                    if(mobile) mobile.style.setProperty('display','block','important');
                }
            }

            setView();
            window.addEventListener('resize', setView);
            console.log('ExportHistory view toggler active');
        }catch(e){ console.warn('ExportHistory toggler failed', e); }
    })();
</script>
