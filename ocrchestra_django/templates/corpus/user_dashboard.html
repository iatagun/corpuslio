<!-- htmlhint-disable -->
<!-- @ts-nocheck -->
{% extends 'base.html' %}
{% load static %}

{% block title %}My Dashboard - OCRchestra{% endblock %}

{% block extra_css %}
<style>
    .dashboard-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .dashboard-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 10px;
        margin-bottom: 30px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    .dashboard-header h1 {
        margin: 0 0 10px 0;
        font-size: 2em;
    }
    
    .dashboard-header p {
        margin: 0;
        opacity: 0.9;
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .stat-card .icon {
        font-size: 2.5em;
        margin-bottom: 10px;
        opacity: 0.7;
    }
    
    .stat-card h3 {
        margin: 0 0 10px 0;
        font-size: 0.9em;
        text-transform: uppercase;
        color: #666;
    }
    
    .stat-card .value {
        font-size: 2.5em;
        font-weight: bold;
        color: #667eea;
        margin-bottom: 10px;
    }
    
    .stat-card .subtext {
        font-size: 0.85em;
        color: #999;
    }
    
    .progress-bar {
        width: 100%;
        height: 8px;
        background: #e0e0e0;
        border-radius: 4px;
        overflow: hidden;
        margin-top: 10px;
    }
    
    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea, #764ba2);
        transition: width 0.3s ease;
    }
    
    .charts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .chart-card {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .chart-card h3 {
        margin: 0 0 20px 0;
        color: #333;
    }
    
    .chart-container {
        position: relative;
        height: 300px;
    }
    
    .activity-timeline {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-top: 20px;
    }
    
    .activity-timeline h3 {
        margin: 0 0 20px 0;
        color: #333;
    }
    
    .activity-item {
        display: flex;
        align-items: center;
        padding: 15px;
        border-left: 3px solid #667eea;
        margin-bottom: 15px;
        background: #f9f9f9;
        border-radius: 5px;
        transition: background 0.2s;
    }
    
    .activity-item:hover {
        background: #f0f0f0;
    }
    
    .activity-icon {
        font-size: 1.8em;
        margin-right: 15px;
        color: #667eea;
    }
    
    .activity-icon.query { color: #667eea; }
    .activity-icon.export { color: #10b981; }
    .activity-icon.upload { color: #f59e0b; }
    
    .activity-content {
        flex: 1;
    }
    
    .activity-description {
        font-weight: 500;
        margin-bottom: 5px;
    }
    
    .activity-time {
        font-size: 0.85em;
        color: #999;
    }
    
    .quick-actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-top: 30px;
    }
    
    .quick-action-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 15px;
        background: white;
        border: 2px solid #667eea;
        border-radius: 8px;
        color: #667eea;
        text-decoration: none;
        font-weight: 500;
        transition: all 0.2s;
    }
    
    .quick-action-btn:hover {
        background: #667eea;
        color: white;
        transform: translateY(-2px);
    }
    
    .quick-action-btn .material-icons {
        margin-right: 8px;
    }
    
    .empty-state {
        text-align: center;
        padding: 40px;
        color: #999;
    }
    
    .empty-state .material-icons {
        font-size: 4em;
        opacity: 0.3;
        margin-bottom: 10px;
    }
    
    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }
        .charts-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Header -->
    <div class="dashboard-header">
        <h1>Welcome back, {{ user.get_full_name|default:user.username }}!</h1>
        <p>
            <strong>{{ user_role|title }}</strong> member since {{ member_since|date:"F Y" }}
        </p>
    </div>
    
    <!-- Stats Cards -->
    <div class="stats-grid">
        <!-- Documents Card -->
        <div class="stat-card">
            <span class="material-icons icon">description</span>
            <h3>My Documents</h3>
            <div class="value">{{ total_docs }}</div>
            <div class="subtext">Uploaded documents</div>
        </div>
        
        <!-- Queries Card -->
        <div class="stat-card">
            <span class="material-icons icon">search</span>
            <h3>Queries Today</h3>
            <div class="value">{{ queries_today }}</div>
            <div class="subtext">{{ total_queries }} total queries</div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: {{ quota_percentage }}%"></div>
            </div>
            <div class="subtext" style="margin-top: 5px;">
                {{ quotas.queries_this_month }} / {{ quotas.monthly_query_limit }} this month
            </div>
        </div>
        
        <!-- Exports Card -->
        <div class="stat-card">
            <span class="material-icons icon">download</span>
            <h3>Exports Today</h3>
            <div class="value">{{ exports_today }}</div>
            <div class="subtext">{{ total_exports }} total exports</div>
            <div class="progress-bar">
                <div class="progress-fill" style="width: {{ export_percentage }}%"></div>
            </div>
            <div class="subtext" style="margin-top: 5px;">
                {{ quotas.exports_today }} / {{ quotas.daily_export_limit }} daily limit
            </div>
        </div>
        
        <!-- API Keys Card (if API enabled) -->
        {% if has_api %}
        <div class="stat-card">
            <span class="material-icons icon">vpn_key</span>
            <h3>API Keys</h3>
            <div class="value">{{ api_stats.keys_count }}</div>
            <div class="subtext">{{ api_stats.requests_today }} requests today</div>
            <div class="subtext">{{ api_stats.total_requests }} total requests</div>
        </div>
        {% endif %}
    </div>
    
    <!-- Charts -->
    <div class="charts-grid">
        <!-- Query Timeline Chart -->
        <div class="chart-card">
            <h3>Query Activity (Last 30 Days)</h3>
            <div class="chart-container">
                <canvas id="queryTimelineChart"></canvas>
            </div>
        </div>
        
        <!-- Query Types Distribution -->
        <div class="chart-card">
            <h3>Query Types Distribution</h3>
            <div class="chart-container">
                <canvas id="queryTypesChart"></canvas>
            </div>
        </div>
        
        <!-- Export Formats Distribution -->
        <div class="chart-card">
            <h3>Export Formats (Last 30 Days)</h3>
            <div class="chart-container">
                <canvas id="exportFormatsChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Recent Activity Timeline -->
    <div class="activity-timeline">
        <h3>Recent Activity</h3>
        
        {% if activities %}
            {% for activity in activities %}
            <div class="activity-item">
                <span class="material-icons activity-icon {{ activity.type }}">
                    {{ activity.icon }}
                </span>
                <div class="activity-content">
                    <div class="activity-description">{{ activity.description }}</div>
                    <div class="activity-time">{{ activity.timestamp|timesince }} ago</div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <span class="material-icons">inbox</span>
                <p>No recent activity</p>
            </div>
        {% endif %}
    </div>
    
    <!-- Quick Actions -->
    <div class="quick-actions">
        <a href="{% url 'corpus:upload_document' %}" class="quick-action-btn">
            <span class="material-icons">upload_file</span>
            Upload Document
        </a>
        <a href="{% url 'corpus:search' %}" class="quick-action-btn">
            <span class="material-icons">search</span>
            New Search
        </a>
        <a href="{% url 'corpus:download_center' %}" class="quick-action-btn">
            <span class="material-icons">folder_open</span>
            Download Center
        </a>
        <a href="{% url 'corpus:document_list' %}" class="quick-action-btn">
            <span class="material-icons">folder</span>
            Browse Corpus
        </a>
        {% if has_api %}
        <a href="/api/docs/" class="quick-action-btn" target="_blank">
            <span class="material-icons">api</span>
            API Documentation
        </a>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
    // Parse data from Django context
    const queryTimeline = {{ query_timeline|safe }};
    const queryTypes = {{ query_types|safe }};
    const exportFormats = {{ export_formats|safe }};
    
    // Chart.js default configuration
    Chart.defaults.font.family = "'Inter', sans-serif";
    Chart.defaults.color = '#666';
    
    // Query Timeline Chart
    const queryTimelineCtx = document.getElementById('queryTimelineChart').getContext('2d');
    new Chart(queryTimelineCtx, {
        type: 'line',
        data: {
            labels: queryTimeline.map(d => d.date),
            datasets: [{
                label: 'Queries',
                data: queryTimeline.map(d => d.count),
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                borderWidth: 2,
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0
                    }
                },
                x: {
                    ticks: {
                        maxRotation: 45,
                        minRotation: 45
                    }
                }
            }
        }
    });
    
    // Query Types Chart
    if (queryTypes.length > 0) {
        const queryTypesCtx = document.getElementById('queryTypesChart').getContext('2d');
        new Chart(queryTypesCtx, {
            type: 'doughnut',
            data: {
                labels: queryTypes.map(d => d.type.charAt(0).toUpperCase() + d.type.slice(1)),
                datasets: [{
                    data: queryTypes.map(d => d.count),
                    backgroundColor: [
                        '#667eea',
                        '#764ba2',
                        '#f093fb',
                        '#4facfe',
                        '#43e97b'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
    
    // Export Formats Chart
    if (exportFormats.length > 0) {
        const exportFormatsCtx = document.getElementById('exportFormatsChart').getContext('2d');
        new Chart(exportFormatsCtx, {
            type: 'bar',
            data: {
                labels: exportFormats.map(d => d.format.toUpperCase()),
                datasets: [{
                    label: 'Exports',
                    data: exportFormats.map(d => d.count),
                    backgroundColor: '#10b981'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0
                        }
                    }
                }
            }
        });
    }
</script>
{% endblock %}
