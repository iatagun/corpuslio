{% load static %}
{% load auth_extras %}
<!DOCTYPE html>
<html lang="tr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}CorpusLIO{% endblock %}</title>
    <link rel="stylesheet" href="{% static 'css/styles.css' %}?v=4">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    {% block extra_css %}{% endblock %}
</head>

<body>
    <!-- Sidebar Navigation -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <a href="{% url 'corpus:home' %}" class="logo-link">
                <h2 class="sidebar-logo"><span class="material-icons">graphic_eq</span> CorpusLIO</h2>
            </a>
        </div>

        <nav class="sidebar-nav">
            <a href="{% url 'corpus:home' %}" class="nav-item {% if active_tab == 'home' %}active{% endif %}">
                <span class="material-icons nav-icon">home</span>
                <span class="nav-text">Ana Sayfa</span>
            </a>

            <a href="{% url 'corpus:library' %}" class="nav-item {% if active_tab == 'library' %}active{% endif %}">
                <span class="material-icons nav-icon">library_books</span>
                <span class="nav-text">KÃ¼tÃ¼phane</span>
            </a>

            {% load auth_extras %}
            {% if user.is_authenticated %}
            <a href="{% url 'corpus:corpus_search' %}"
                class="nav-item {% if active_tab == 'search' %}active{% endif %}">
                <span class="material-icons nav-icon">search</span>
                <span class="nav-text">Korpus Arama</span>
            </a>
            {% endif %}

            {% if user.is_authenticated %}
            <a href="{% url 'corpus:collections' %}"
                class="nav-item {% if active_tab == 'collections' %}active{% endif %}">
                <span class="material-icons nav-icon">collections_bookmark</span>
                <span class="nav-text">Koleksiyonlar</span>
            </a>
            <a href="{% url 'corpus:dashboard' %}" class="nav-item {% if active_tab == 'dashboard' %}active{% endif %}">
                <span class="material-icons nav-icon">dashboard</span>
                <span class="nav-text">Dashboard</span>
            </a>
            <a href="{% url 'corpus:statistics' %}"
                class="nav-item {% if active_tab == 'statistics' %}active{% endif %}">
                <span class="material-icons nav-icon">analytics</span>
                <span class="nav-text">Korpus Ä°statistikleri</span>
            </a>

            {% if request.user|has_group:"Academician" %}
            <a href="/api/docs/" class="nav-item" target="_blank">
                <span class="material-icons nav-icon">api</span>
                <span class="nav-text">API Docs</span>
            </a>
            {% endif %}

            {% else %}
            <!-- Public Access - Limited Menu -->
            <div style="margin-top: 1rem; padding: 0 1rem;">
                <p
                    style="font-size: 0.75rem; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem;">
                    Ãœyelik
                </p>
                <a href="{% url 'corpus:login' %}" class="nav-item">
                    <span class="material-icons nav-icon">login</span>
                    <span class="nav-text">GiriÅŸ Yap</span>
                </a>
                <a href="{% url 'corpus:register' %}" class="nav-item">
                    <span class="material-icons nav-icon">person_add</span>
                    <span class="nav-text">KayÄ±t Ol</span>
                </a>
            </div>
            {% endif %}
        </nav>
    </aside>

    <!-- Main Content Wrapper -->
    <div class="main-wrapper">
        <!-- Top Header -->
        <header class="top-header">
            <div class="breadcrumb">
                {% block breadcrumb %}
                <a href="{% url 'corpus:home' %}">Ana Sayfa</a>
                {% endblock %}
            </div>

            <div style="display: flex; align-items: center; gap: 15px;">
                <!-- Language Switcher -->
                {% load i18n %}
                <div class="language-switcher" style="display:none;">
                    <button class="language-btn" onclick="toggleLanguageMenu()" title="Dil DeÄŸiÅŸtir / Change Language">
                        {{ LANGUAGE_CODE|upper }}
                    </button>
                    <div class="language-menu" id="languageMenu">
                        <form action="{% url 'set_language' %}" method="post">
                            {% csrf_token %}
                            <input name="next" type="hidden" value="{{ request.path }}">
                            {% get_current_language as LANGUAGE_CODE %}
                            {% get_available_languages as LANGUAGES %}
                            {% for lang_code, lang_name in LANGUAGES %}
                            <button type="submit" name="language" value="{{ lang_code }}"
                                class="language-option {% if LANGUAGE_CODE == lang_code %}active{% endif %}">
                                <span class="flag-icon">{% if lang_code == 'tr' %}ðŸ‡¹ðŸ‡·{% else %}ðŸ‡¬ðŸ‡§{% endif %}</span>
                                <span>{{ lang_name }}</span>
                            </button>
                            {% endfor %}
                        </form>
                    </div>
                </div>

                <!-- Theme Switcher -->
                <div class="theme-switcher" style="display:none;">
                    <button class="theme-btn" onclick="toggleThemeMenu()" title="Tema DeÄŸiÅŸtir">
                        <span class="material-icons theme-icon">palette</span>
                    </button>
                    <div class="theme-menu" id="themeMenu">
                        <div class="theme-option" onclick="setTheme('dark')">
                            <span class="material-icons">dark_mode</span>
                            <span>Koyu Tema</span>
                            <span class="theme-check" id="check-dark"></span>
                        </div>
                        <div class="theme-option disabled" style="opacity:0.5; pointer-events:none;" aria-disabled="true">
                            <span class="material-icons">light_mode</span>
                            <span>AÃ§Ä±k Tema (devre dÄ±ÅŸÄ±)</span>
                            <span class="theme-check" id="check-light"></span>
                        </div>
                        <div class="theme-option disabled" style="opacity:0.5; pointer-events:none;" aria-disabled="true">
                            <span class="material-icons">brightness_auto</span>
                            <span>Otomatik (devre dÄ±ÅŸÄ±)</span>
                            <span class="theme-check" id="check-auto"></span>
                        </div>
                    </div>
                </div>

                <!-- Profile Section -->
                <div class="profile-section">
                    {% if user.is_authenticated %}
                    {% load auth_extras %}
                    <div class="profile-dropdown">
                        <div class="profile-avatar">
                            <span class="material-icons" style="font-size: 18px;">person</span>
                        </div>
                        <div class="profile-info">
                            <span class="profile-name">{{ user.get_full_name|default:user.username }}</span>
                            <span class="profile-role">{{ request.user|access_level }}</span>
                        </div>
                        <span class="material-icons dropdown-arrow"
                            style="font-size: 18px; margin-left: 8px;">expand_more</span>
                    </div>

                    <div class="dropdown-menu" id="profileDropdown">
                        <a href="{% url 'corpus:profile' %}" class="dropdown-item">
                            <span class="material-icons">account_circle</span>
                            <span>Profil</span>
                        </a>
                        <a href="{% url 'corpus:login_history' %}" class="dropdown-item">
                            <span class="material-icons">shield</span>
                            <span>GiriÅŸ GeÃ§miÅŸi</span>
                        </a>
                        {% if user.is_staff %}
                        <a href="/admin/" class="dropdown-item" target="_blank">
                            <span class="material-icons">admin_panel_settings</span>
                            <span>Admin Paneli</span>
                        </a>
                        {% endif %}
                        <div class="dropdown-divider"></div>
                        <a href="{% url 'corpus:logout' %}" class="dropdown-item logout">
                            <span class="material-icons">logout</span>
                            <span>Ã‡Ä±kÄ±ÅŸ Yap</span>
                        </a>
                    </div>

                    {% else %}
                    <div style="display: flex; gap: 10px;">
                        <a href="{% url 'corpus:login' %}" class="btn btn-outline btn-small"
                            style="padding: 0.4rem 0.8rem;">
                            <span class="material-icons" style="font-size: 16px;">login</span> GiriÅŸ
                        </a>
                        <a href="{% url 'corpus:register' %}" class="btn btn-primary btn-small"
                            style="padding: 0.4rem 0.8rem;">
                            <span class="material-icons" style="font-size: 16px;">person_add</span> KayÄ±t
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </header>

        <!-- Messages are handled by Toast system below -->

        <!-- Page Content -->
        <main class="content-area">
            <!-- Global Loading Overlay (can be triggered from any page) -->
            <div id="globalLoading" class="loading-overlay hidden">
                <div class="spinner-large"></div>
                <div class="loading-text" id="globalLoadingText">YÃ¼kleniyor...</div>
            </div>

            <!-- Toast Notification Container -->
            <div id="toastContainer" class="toast-container"></div>

            <!-- Global Search Modal (Ctrl+K) -->
            <div id="searchModal" class="search-modal-backdrop">
                <div class="search-modal">
                    <div class="search-modal-header">
                        <span class="material-icons">search</span>
                        <input type="text" id="searchInput" class="search-modal-input"
                            placeholder="Belgeler ve koleksiyonlarda ara..." autocomplete="off">
                        <div class="custom-select" id="searchType" role="combobox" aria-haspopup="listbox"
                            aria-expanded="false">
                            <button type="button" class="custom-select-trigger" aria-label="Arama Tipi">Basit</button>
                            <ul class="custom-select-options" role="listbox" tabindex="-1">
                                <li role="option" data-value="basic" aria-selected="true">Basit</li>
                                <li role="option" data-value="fuzzy">Benzer</li>
                                <li role="option" data-value="regex">Regex</li>
                            </ul>
                            <input type="hidden" name="search_type" id="searchTypeValue" value="basic">
                        </div>
                        <div class="search-modal-shortcut">
                            <span>ESC</span>
                        </div>
                    </div>
                    <div class="search-modal-body" id="searchResults">
                        <div class="search-modal-empty">
                            <span class="material-icons">search</span>
                            <p>Aramaya baÅŸlamak iÃ§in yazmaya baÅŸlayÄ±n</p>
                            <div style="font-size: 0.85rem; color: var(--text-tertiary); margin-top: 0.5rem;">
                                <strong>Ä°puÃ§larÄ±:</strong><br>
                                â€¢ Basit: Kelime eÅŸleÅŸtirme<br>
                                â€¢ Benzer: YakÄ±n eÅŸleÅŸmeler (fuzzy)<br>
                                â€¢ Regex: DÃ¼zenli ifadeler (.*test.*)
                            </div>
                        </div>
                    </div>
                    <div class="search-modal-footer">
                        <div class="search-modal-hint">
                            <kbd>â†‘</kbd>
                            <kbd>â†“</kbd>
                            <span>gezin</span>
                        </div>
                        <div class="search-modal-hint">
                            <kbd>Enter</kbd>
                            <span>seÃ§</span>
                        </div>
                        <div class="search-modal-hint">
                            <kbd>ESC</kbd>
                            <span>kapat</span>
                        </div>
                    </div>
                    <script>
                        (function () {
                            // Custom select for search type
                            var cs = document.getElementById('searchType');
                            if (!cs) return;
                            var trigger = cs.querySelector('.custom-select-trigger');
                            var list = cs.querySelector('.custom-select-options');
                            var hidden = document.getElementById('searchTypeValue');
                            var options = Array.from(list.querySelectorAll('li'));

                            function open() { cs.classList.add('open'); cs.setAttribute('aria-expanded', 'true'); list.setAttribute('aria-hidden', 'false'); list.focus(); }
                            function close() { cs.classList.remove('open'); cs.setAttribute('aria-expanded', 'false'); list.setAttribute('aria-hidden', 'true'); trigger.focus(); }

                            trigger.addEventListener('click', function (e) { if (cs.classList.contains('open')) close(); else open(); });

                            options.forEach(function (opt) {
                                opt.addEventListener('click', function () {
                                    options.forEach(function (o) { o.removeAttribute('aria-selected'); });
                                    opt.setAttribute('aria-selected', 'true');
                                    hidden.value = opt.getAttribute('data-value');
                                    trigger.textContent = opt.textContent;
                                    close();
                                });
                            });

                            // keyboard support
                            list.addEventListener('keydown', function (e) {
                                var idx = options.findIndex(function (o) { return o.getAttribute('aria-selected') === 'true'; });
                                if (e.key === 'ArrowDown') {
                                    e.preventDefault();
                                    var next = options[(idx + 1) % options.length]; next.focus();
                                } else if (e.key === 'ArrowUp') {
                                    e.preventDefault();
                                    var prev = options[(idx - 1 + options.length) % options.length]; prev.focus();
                                } else if (e.key === 'Enter') {
                                    e.preventDefault(); document.activeElement.click();
                                } else if (e.key === 'Escape') {
                                    e.preventDefault(); close();
                                }
                            });

                            // close on outside click
                            document.addEventListener('click', function (ev) { if (!cs.contains(ev.target)) close(); });
                        })();
                    </script>
                </div>
            </div>

            {% block content %}{% endblock %}
        </main>

        <!-- Footer -->
        <footer class="footer">
            <p>&copy; 2026 CorpusLIO - Modern TÃ¼rkÃ§e Korpus Analizi Platformu</p>
            <div class="footer-links">
                <a href="/api/docs/" target="_blank">API DokÃ¼manlarÄ±</a>
                <a href="https://github.com/iatagun/corpuslio" target="_blank">GitHub</a>
            </div>
        </footer>
    </div>

    {% block extra_js %}{% endblock %}

    <script>
        // CSRF Token Configuration for AJAX Requests (Task 11.11)
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        const csrftoken = getCookie('csrftoken');

        // Configure CSRF for all AJAX requests
        if (typeof $ !== 'undefined') {
            // jQuery AJAX setup
            $.ajaxSetup({
                beforeSend: function(xhr, settings) {
                    if (!/^(GET|HEAD|OPTIONS|TRACE)$/.test(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", csrftoken);
                    }
                }
            });
        }

        // Fetch API CSRF setup (for modern JavaScript)
        const originalFetch = window.fetch;
        window.fetch = function(url, options = {}) {
            if (options.method && !/^(GET|HEAD|OPTIONS|TRACE)$/i.test(options.method)) {
                options.headers = options.headers || {};
                options.headers['X-CSRFToken'] = csrftoken;
            }
            return originalFetch(url, options);
        };

        // Simple Toast Notification Function
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            if (!container) return;

            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;

            let icon = 'info';
            if (type === 'success') icon = 'check_circle';
            if (type === 'error' || type === 'warning') icon = 'error';

            toast.innerHTML = `
                <div class="toast-content">
                    <span class="material-icons toast-icon">${icon}</span>
                    <span class="toast-message">${message}</span>
                </div>
                <button class="toast-close" onclick="this.parentElement.remove()">
                    <span class="material-icons">close</span>
                </button>
            `;

            container.appendChild(toast);

            // Auto remove after 5 seconds
            setTimeout(() => {
                if (toast.parentElement) {
                    toast.style.animation = 'slideOut 0.3s forwards';
                    setTimeout(() => toast.remove(), 300);
                }
            }, 5000);
        }
        // Theme Management
        function initTheme() {
            // Force dark theme globally and persist it
            const forced = 'dark';
            try {
                localStorage.setItem('theme', forced);
            } catch (e) {
                console.warn('Unable to persist theme preference', e);
            }
            document.documentElement.setAttribute('data-theme', forced);
            updateThemeChecks(forced);
            updateThemeIcon(forced);
        }

        function setTheme(theme) {
            // Theme selection disabled â€” keep dark enforced
            const forced = 'dark';
            document.documentElement.setAttribute('data-theme', forced);
            try { localStorage.setItem('theme', forced); } catch (e) {}
            updateThemeChecks(forced);
            updateThemeIcon(forced);
            const menu = document.getElementById('themeMenu'); if (menu) menu.classList.remove('show');
        }

        function updateThemeChecks(theme) {
            ['dark', 'light', 'auto'].forEach(t => {
                const check = document.getElementById(`check-${t}`);
                if (check) {
                    check.innerHTML = t === theme ? '<span class="material-icons" style="font-size: 18px; color: var(--accent-primary);">check</span>' : '';
                }
            });
        }

        function updateThemeIcon(theme) {
            const icon = document.querySelector('.theme-icon');
            if (icon) {
                if (theme === 'dark') {
                    icon.textContent = 'dark_mode';
                } else if (theme === 'light') {
                    icon.textContent = 'light_mode';
                } else {
                    icon.textContent = 'brightness_auto';
                }
            }
        }

        function toggleThemeMenu() {
            const menu = document.getElementById('themeMenu');
            menu.classList.toggle('show');
        }

        function toggleLanguageMenu() {
            const menu = document.getElementById('languageMenu');
            menu.classList.toggle('show');
        }

        // Profile Dropdown - make it globally accessible
        window.toggleDropdown = function(event) {
            // If invoked by click handler, prevent the document listener from immediately closing it
            if (event) event.stopPropagation();

            const dropdown = document.getElementById('profileDropdown');
            const pill = document.querySelector('.profile-dropdown');
            if (dropdown) dropdown.classList.toggle('show');
            if (pill) pill.classList.toggle('open');
        };

        // Ensure profile dropdown works even if header is replaced dynamically
        (function bindProfileDropdown() {
            function attach() {
                const pills = document.querySelectorAll('.profile-dropdown');
                if (!pills || pills.length === 0) {
                    console.log('[ProfileDropdown] No .profile-dropdown elements found');
                    return;
                }
                pills.forEach((pill, idx) => {
                    // Remove any inline onclick to avoid duplicate handlers
                    pill.removeAttribute('onclick');
                    // Remove previous listener if present
                    if (window._profileClickHandler) pill.removeEventListener('click', window._profileClickHandler);

                    window._profileClickHandler = function (e) {
                        try {
                            e.stopPropagation();
                        } catch (err) {}
                        const dropdown = document.getElementById('profileDropdown');
                        console.log('[ProfileDropdown] clicked, toggling, index=', idx);
                        if (dropdown) dropdown.classList.toggle('show');
                        pill.classList.toggle('open');
                    };

                    pill.addEventListener('click', window._profileClickHandler);
                    console.log('[ProfileDropdown] Attached click handler to .profile-dropdown index=', idx);
                });
            }

            // Attach on DOMContentLoaded and immediately (if already loaded)
            document.addEventListener('DOMContentLoaded', attach);
            attach();

            // Observe DOM mutations to re-attach if header gets replaced (e.g., after login)
            const observer = new MutationObserver(function () {
                attach();
            });
            observer.observe(document.body, { childList: true, subtree: true });
        })();

        // Close dropdowns when clicking outside (use event listener to avoid overwrite)
        document.addEventListener('click', function (event) {
            if (!event.target.closest('.profile-dropdown')) {
                const dropdown = document.getElementById('profileDropdown');
                const pill = document.querySelector('.profile-dropdown');
                if (dropdown && dropdown.classList.contains('show')) {
                    dropdown.classList.remove('show');
                }
                if (pill && pill.classList.contains('open')) {
                    pill.classList.remove('open');
                }
            }
            if (!event.target.closest('.theme-switcher')) {
                const themeMenu = document.getElementById('themeMenu');
                if (themeMenu && themeMenu.classList.contains('show')) {
                    themeMenu.classList.remove('show');
                }
            }
            if (!event.target.closest('.language-switcher')) {
                const languageMenu = document.getElementById('languageMenu');
                if (languageMenu && languageMenu.classList.contains('show')) {
                    languageMenu.classList.remove('show');
                }
            }
        });

        // Auto-dismiss alerts after 5 seconds
        document.addEventListener('DOMContentLoaded', function () {
            console.log('[Toast Debug] DOMContentLoaded fired');
            initTheme();

            // Convert Django messages to toast notifications (only once)
            {% if messages %}
            console.log('[Toast Debug] Messages block found');
            if (!window._messagesProcessed) {
                window._messagesProcessed = true;
                console.log('[Toast Debug] Processing messages for first time');
                const processedMessages = new Set();
                {% for message in messages %}
                const msgText = '{{ message|escapejs }}';
                const msgType = '{{ message.tags }}';
                const msgKey = msgType + ':' + msgText;
                console.log('[Toast Debug] Message:', msgKey);

                if (!processedMessages.has(msgKey)) {
                    processedMessages.add(msgKey);
                    console.log('[Toast Debug] Showing toast for:', msgText);
                    // Use a function to show toast if available, otherwise alert
                    if (typeof showToast === 'function') {
                        showToast(msgText, msgType);
                    } else {
                        console.warn('showToast function not found');
                    }
                }
                {% endfor %}
            }
            console.log('[Toast Debug] Messages already processed, skipping');
        }
            {% endif %}
        });

        // Global Loading Helper Functions
        window.showLoading = function (message = 'YÃ¼kleniyor...') {
            const overlay = document.getElementById('globalLoading');
            const text = document.getElementById('globalLoadingText');
            if (overlay) {
                text.textContent = message;
                overlay.classList.remove('hidden');
            }
        };

        window.hideLoading = function () {
            const overlay = document.getElementById('globalLoading');
            if (overlay) {
                overlay.classList.add('hidden');
            }
        };

        // Toast Notification System
        let toastQueue = [];
        const MAX_TOASTS = 3;
        const recentToasts = new Map(); // Track recent toasts to prevent duplicates

        window.showToast = function (options) {
            console.log('[Toast] showToast called with:', options);
            // Options: { type, title, message, duration }
            const defaults = {
                type: 'info', // success, error, warning, info
                title: '',
                message: '',
                duration: 5000
            };

            const config = { ...defaults, ...options };
            console.log('[Toast] Config:', config);

            // Prevent duplicate toasts within 1 second
            const toastKey = `${config.type}:${config.message}`;
            const now = Date.now();
            if (recentToasts.has(toastKey)) {
                const lastShown = recentToasts.get(toastKey);
                if (now - lastShown < 1000) {
                    console.log('[Toast] Duplicate toast prevented:', toastKey);
                    return null;
                }
            }
            recentToasts.set(toastKey, now);

            // Clean up old entries
            setTimeout(() => recentToasts.delete(toastKey), 2000);

            // Icon mapping
            const icons = {
                success: 'check_circle',
                error: 'error',
                warning: 'warning',
                info: 'info'
            };

            // Create toast element
            const toast = document.createElement('div');
            toast.className = `toast toast-${config.type}`;

            toast.innerHTML = `
                <div class="toast-icon">
                    <span class="material-icons">${icons[config.type]}</span>
                </div>
                <div class="toast-content">
                    ${config.title ? `<div class="toast-title">${config.title}</div>` : ''}
                    <div class="toast-message">${config.message}</div>
                </div>
                <button class="toast-close" onclick="closeToast(this)">
                    <span class="material-icons" style="font-size: 18px;">close</span>
                </button>
                ${config.duration > 0 ? '<div class="toast-progress"><div class="toast-progress-bar"></div></div>' : ''}
            `;

            const container = document.getElementById('toastContainer');

            // Remove oldest toast if max limit reached
            const existingToasts = container.querySelectorAll('.toast');
            if (existingToasts.length >= MAX_TOASTS) {
                closeToast(existingToasts[0].querySelector('.toast-close'));
            }

            container.appendChild(toast);

            // Auto dismiss
            if (config.duration > 0) {
                setTimeout(() => {
                    closeToast(toast.querySelector('.toast-close'));
                }, config.duration);
            }

            return toast;
        };

        window.closeToast = function (element) {
            const toast = element.closest ? element.closest('.toast') : element;
            if (toast) {
                toast.classList.add('removing');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }
        };

        // Convenience methods
        window.toastSuccess = function (message, title = 'BaÅŸarÄ±lÄ±!') {
            return showToast({ type: 'success', title, message });
        };

        window.toastError = function (message, title = 'Hata!') {
            return showToast({ type: 'error', title, message });
        };

        window.toastWarning = function (message, title = 'UyarÄ±!') {
            return showToast({ type: 'warning', title, message });
        };

        window.toastInfo = function (message, title = 'Bilgi') {
            return showToast({ type: 'info', title, message });
        };

        // ========================================
        // GLOBAL SEARCH (Ctrl+K)
        // ========================================

        let searchTimeout = null;
        let currentSearchResults = [];
        let selectedResultIndex = -1;

        // Open search modal with Ctrl+K or Cmd+K
        document.addEventListener('keydown', function (e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                openSearchModal();
            }
        });

        function openSearchModal() {
            const modal = document.getElementById('searchModal');
            const input = document.getElementById('searchInput');
            modal.classList.add('active');
            setTimeout(() => input.focus(), 100);
        }

        function closeSearchModal() {
            const modal = document.getElementById('searchModal');
            const input = document.getElementById('searchInput');
            modal.classList.remove('active');
            input.value = '';
            currentSearchResults = [];
            selectedResultIndex = -1;
            showEmptyState();
        }

        // Close on backdrop click
        document.getElementById('searchModal').addEventListener('click', function (e) {
            if (e.target === this) {
                closeSearchModal();
            }
        });

        // Close on ESC key
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape' && document.getElementById('searchModal').classList.contains('active')) {
                closeSearchModal();
            }
        });

        // Search input handler
        document.getElementById('searchInput').addEventListener('input', function (e) {
            const query = e.target.value.trim();

            // Clear previous timeout
            if (searchTimeout) {
                clearTimeout(searchTimeout);
            }

            if (query.length === 0) {
                showEmptyState();
                return;
            }

            // Request suggestions immediately
            fetch(`/corpus/suggest/?q=${encodeURIComponent(query)}`, {
                method: 'GET',
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            })
                .then(r => r.json())
                .then(s => {
                    if (s.suggestions && s.suggestions.length > 0) {
                        displaySuggestions(s.suggestions);
                    } else {
                        // If query long enough, perform full search
                        if (query.length >= 2) {
                            showSearchLoading();
                            if (searchTimeout) clearTimeout(searchTimeout);
                            searchTimeout = setTimeout(() => performSearch(query), 300);
                        } else {
                            showEmptyState();
                        }
                    }
                })
                .catch(() => {
                    if (query.length >= 2) {
                        showSearchLoading();
                        if (searchTimeout) clearTimeout(searchTimeout);
                        searchTimeout = setTimeout(() => performSearch(query), 300);
                    }
                });
        });

        // Keyboard navigation (arrow keys and Enter)
        document.getElementById('searchInput').addEventListener('keydown', function (e) {
            if (currentSearchResults.length === 0) return;

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedResultIndex = Math.min(selectedResultIndex + 1, currentSearchResults.length - 1);
                updateSelectedResult();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedResultIndex = Math.max(selectedResultIndex - 1, -1);
                updateSelectedResult();
            } else if (e.key === 'Enter' && selectedResultIndex >= 0) {
                e.preventDefault();
                const selectedResult = currentSearchResults[selectedResultIndex];
                if (selectedResult && selectedResult.url) {
                    window.location.href = selectedResult.url;
                }
            }
        });

        function performSearch(query) {
            const searchType = document.getElementById('searchType').value;

            // Make AJAX request to search endpoint
            fetch(`/corpus/search/?q=${encodeURIComponent(query)}&type=${searchType}`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        showSearchError(data.error);
                        return;
                    }
                    currentSearchResults = data.results || [];
                    selectedResultIndex = -1;
                    displaySearchResults(data);
                })
                .catch(error => {
                    console.error('Search error:', error);
                    showSearchError();
                });
        }

        function displaySearchResults(data) {
            const resultsContainer = document.getElementById('searchResults');

            if (!data.results || data.results.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="search-modal-empty">
                        <span class="material-icons">search_off</span>
                        <p>SonuÃ§ bulunamadÄ±</p>
                    </div>
                `;
                return;
            }

            let html = '';

            // Group results by type
            const documents = data.results.filter(r => r.type === 'document');
            const collections = data.results.filter(r => r.type === 'collection');

            if (documents.length > 0) {
                html += '<div class="search-modal-section">';
                html += '<div class="search-modal-section-title">Belgeler</div>';
                documents.forEach((result, index) => {
                    html += createResultItem(result, index);
                });
                html += '</div>';
            }

            if (collections.length > 0) {
                html += '<div class="search-modal-section">';
                html += '<div class="search-modal-section-title">Koleksiyonlar</div>';
                collections.forEach((result, index) => {
                    html += createResultItem(result, documents.length + index);
                });
                html += '</div>';
            }

            resultsContainer.innerHTML = html;
        }

        function createResultItem(result, index) {
            const iconClass = result.type === 'document' ? 'document' : 'collection';
            const icon = result.type === 'document' ? 'description' : 'collections_bookmark';

            return `
                <a href="${result.url}" class="search-result-item" data-index="${index}">
                    <div class="search-result-icon ${iconClass}">
                        <span class="material-icons">${icon}</span>
                    </div>
                    <div class="search-result-content">
                        <div class="search-result-title">${result.title}</div>
                        <div class="search-result-meta">
                            ${result.metadata || ''}
                        </div>
                    </div>
                    ${result.badge ? `
                        <div class="search-result-badge">
                            <span class="material-icons">${result.badge_icon || 'label'}</span>
                            <span>${result.badge}</span>
                        </div>
                    ` : ''}
                </a>
            `;
        }

        function updateSelectedResult() {
            const items = document.querySelectorAll('.search-result-item');
            items.forEach((item, index) => {
                if (index === selectedResultIndex) {
                    item.classList.add('active');
                    item.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                } else {
                    item.classList.remove('active');
                }
            });
        }

        function showEmptyState() {
            document.getElementById('searchResults').innerHTML = `
                <div class="search-modal-empty">
                    <span class="material-icons">search</span>
                    <p>Aramaya baÅŸlamak iÃ§in yazmaya baÅŸlayÄ±n</p>
                </div>
            `;
        }

        function showSearchLoading() {
            document.getElementById('searchResults').innerHTML = `
                <div class="search-loading">
                    <div class="spinner-small"></div>
                    <p>AranÄ±yor...</p>
                </div>
            `;
        }

        function showSearchError(message = 'Arama sÄ±rasÄ±nda bir hata oluÅŸtu') {
            document.getElementById('searchResults').innerHTML = `
                <div class="search-modal-empty">
                    <span class="material-icons" style="color:var(--accent-danger);">error</span>
                    <p>${message}</p>
                </div>
            `;
        }

        function displaySuggestions(suggestions) {
            const container = document.getElementById('searchResults');
            if (!suggestions || suggestions.length === 0) {
                showEmptyState();
                return;
            }
            let html = '<div class="search-modal-section">';
            html += '<div class="search-modal-section-title">Ã–neriler</div>';
            suggestions.forEach((s, idx) => {
                html += `
                    <a href="#" class="search-suggestion-item" data-value="${s.value}" data-index="${idx}">
                        <div class="search-result-icon suggestion"><span class="material-icons">lightbulb</span></div>
                        <div class="search-result-content">
                            <div class="search-result-title">${s.value}</div>
                            <div class="search-result-meta">${s.type}</div>
                        </div>
                    </a>
                `;
            });
            html += '</div>';
            container.innerHTML = html;

            // Attach click handlers
            container.querySelectorAll('.search-suggestion-item').forEach(el => {
                el.addEventListener('click', function (e) {
                    e.preventDefault();
                    const v = this.getAttribute('data-value');
                    document.getElementById('searchInput').value = v;
                    performSearch(v);
                });
            });
        }
    </script>
</body>

</html>